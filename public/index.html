<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fingerprint Attendance System</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
          body {
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
    background: url('https://images.pexels.com/photos/325185/pexels-photo-325185.jpeg') no-repeat center center fixed;
        background-size: cover;
            color: #2c3e50;
          }
          #loginContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.10);
            z-index: 99999;
          }
          #loginForm {
            background: rgba(30,30,30,0.55);
            padding: 22px 20px 18px 20px;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(44,62,80,0.18);
            min-width: 320px;
            max-width: 370px;
            width: 370px;
            border: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            backdrop-filter: blur(2px);
          }
          #loginForm h2 {
            margin-bottom: 10px;
            color: #fff;
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 1px;
          }
          #loginForm label {
            color: #fff;
            font-weight: 500;
            margin-bottom: 2px;
          }
          #loginForm input[type="email"],
          #loginForm input[type="password"] {
            width: 100%;
            padding: 7px 10px;
            border-radius: 7px;
            border: 1.3px solid #b3d6f7;
            font-size: 1em;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.92);
            color: #222;
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
            outline: none;
            transition: box-shadow 0.2s;
          }
          /* Compact verification mode */
          #loginContainer.login-compact #loginForm {
            min-width: 260px;
            max-width: 320px;
            width: 320px;
            padding: 14px 12px;
            align-items: center;
          }
          #loginContainer.login-compact #loginForm h2 {
            font-size: 1.2em;
            margin-bottom: 6px;
          }
          #loginContainer.login-compact #codePrompt {
            font-size: 0.85em;
            font-weight: 500;
            color: #e9f6f0;
            text-align: center;
          }
          #loginContainer.login-compact #loginCode {
            width: 110px;
            font-size: 1.1em;
            padding: 6px 8px;
          }
          #loginContainer.login-compact #codeRow {
            display: flex;
            justify-content: center;
            width: 100%;
          }
          /* Ensure the code row centers its contents even when inline styles set display:block */
          #codeRow { text-align: center; }
          #loginCode { display: inline-block; margin: 6px auto; }
          #loginContainer.login-compact #loginActions {
            display: flex;
            gap: 8px;
            justify-content: center;
            width: 100%;
          }
          #loginForm input[type="email"]:focus,
          #loginForm input[type="password"]:focus {
            box-shadow: 0 2px 12px #1abc9c44;
          }
          #loginForm button[type="submit"] {
            background: #1abc9c;
            color: #fff;
            border: none;
            padding: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            margin-top: 4px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
            transition: background 0.2s;
          }
          #loginForm button[type="submit"]:hover {
            background: #0099cc;
          }
          #loginMsg {
            margin-top: 4px;
            color: #ffdddd;
            text-align: center;
            font-size: 0.98em;
          }
    .container {
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 210px;
      background: linear-gradient(180deg, #2c3e50 80%, #1abc9c 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 30px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.07);
      min-width: 210px;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.3em;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .sidebar button {
      background: none;
      border: none;
      color: #fff;
      padding: 15px 30px;
      text-align: left;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.2s, border-left 0.2s;
      border-left: 4px solid transparent;
      outline: none;
      border-radius: 0 20px 20px 0;
      margin-bottom: 2px;
    }
    .sidebar button.active, .sidebar button:hover {
      background: #1abc9c;
      border-left: 4px solid #fff;
      color: #fff;
    }

    /* Only make Students Info button fill the full width visually */
    #studentsBtn {
      display: block;
      width: 100%;
      box-sizing: border-box;
      padding: 15px 30px;
      border-radius: 0 20px 20px 0;
      margin-bottom: 2px;
    }
    #studentsBtn.active, #studentsBtn:hover {
      background: #1abc9c;
      border-left: 4px solid #fff;
      color: #fff;
    }
    .main {
      flex: 1;
      padding: 32px 32px 32px 32px;
      overflow-y: auto;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }
    .card {
          background: rgba(255,255,255,0.65);
          border-radius: 20px;
          box-shadow: 0 2px 16px rgba(44,62,80,0.08);
          padding: 18px 36px;
          margin-bottom: 32px;
          width: 100%;
    box-sizing: border-box;
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
          min-width: 0;
          border: none;
        }
    .filter-bar {
      background: #eef2f6;
      border-radius: 8px;
      padding: 18px 20px;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: center;
    }
    .filter-bar label {
      font-weight: 600;
      color: #34495e;
      margin-right: 8px;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 1em;
      box-sizing: border-box;
      background: #fff;
      transition: border-color 0.2s;
    }
    input:focus, select:focus {
      border-color: #1abc9c;
      outline: none;
    }
    button[type="submit"], .main button {
      background: linear-gradient(90deg, #1abc9c 70%, #16a085 100%);
      color: #fff;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 10px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(44,62,80,0.07);
      transition: background 0.2s;
    }
    button[type="submit"]:hover, .main button:hover {
      background: linear-gradient(90deg, #16a085 70%, #1abc9c 100%);
    }
    button[type="submit"]:disabled, .main button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #34495e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: rgba(255,255,255,0.35);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(44,62,80,0.04);
      backdrop-filter: blur(1.5px);
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 1em;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #e1e4e8;
      text-align: left;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 1em;
      letter-spacing: 0.5px;
    }
    th {
      background: rgba(255,255,255,0.18);
      font-weight: 700;
      color: #2c3e50;
      font-size: 0.88em;
      letter-spacing: 0.5px;
      backdrop-filter: blur(1.5px);
    }
    tr:last-child td {
      border-bottom: none;
    }
    h2 {
      margin: 0 0 24px 0;
      text-align: left;
      font-size: 1.7em;
      color: #1abc9c;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .sidebar-footer {
      margin-top: auto;
      padding: 20px 30px;
      font-size: 0.95em;
      color: #e1e4e8;
      text-align: center;
      letter-spacing: 0.5px;
    }
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:18px}
.card{background:rgba(255,255,255,0.18);padding:14px;border-radius:10px;box-shadow:0 1px 2px rgba(12,17,23,0.06)}
.card-title{font-size:13px;color:#6b7280}
.card-value{font-size:20px;font-weight:700;margin-top:6px}
.analytics-btn{background:#fff;border:1.5px solid #159c85;color:#1abc9c;padding:10px 14px;border-radius:10px;cursor:pointer}
.analytics-cards{display:flex;gap:10px}
.analytics-card{background:rgba(255,255,255,0.18);padding:18px 24px;border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);cursor:pointer;flex:1;text-align:center;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:8px;transition:transform .18s, box-shadow .18s}
.analytics-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(2,6,23,0.12)}
.card-icon{font-size:24px;display:inline-block;width:44px;height:44px;line-height:44px;border-radius:10px;color:#fff;margin-bottom:4px}
.card-label{font-size:14px}
@media (max-width:900px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:560px){.stats-grid{grid-template-columns:1fr}}
    /* Ensure Event Management table fonts and header styles match Students Info table
       Keep existing padding/spacing intact (we only change font family, sizes, weight, and color) */
    #eventsSection table, #eventsSection table th, #eventsSection table td {
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #eventsSection table th {
      font-weight: 700;
      color: #2c3e50;
      font-size: 0.88em;
      letter-spacing: 0.5px;
      text-align: left;
    }
    /* Match student row font sizing/style (keeps compact rows) */
    #eventsSection table td {
      font-size: 0.78em;
      color: #222;
    }
    /* Highlight active event rows */
    .active-event {
      background: linear-gradient(90deg, rgba(26,188,156,0.06), rgba(255,255,255,0.02));
      border-left: 6px solid #1abc9c;
    }
    .active-event td { background: transparent; }
  </style>
</head>
<body>
  <div id="loginContainer">
    <form id="loginForm">
  <h2>Log In</h2>
      <label for="loginEmail" style="margin-bottom:2px;font-weight:500;">Email</label>
      <input type="email" id="loginEmail" name="email" required style="margin-bottom:6px;padding:7px 10px;font-size:1em;border-radius:7px;border:1.3px solid #b3d6f7;">
  <label for="loginPassword" style="margin-top:6px;margin-bottom:2px;font-weight:500;">Password</label>
  <input type="password" id="loginPassword" name="password" required style="margin-bottom:6px;padding:7px 10px;font-size:1em;border-radius:7px;border:1.3px solid #b3d6f7;">

      <!-- Two-step code login: send a 6-digit code to the user's email, then verify -->
      <div id="codePrompt" style="display:none;margin-top:8px;font-weight:500;"></div>
      <div id="codeRow" style="display:none;margin-top:8px;">
        <input type="text" id="loginCode" name="code" maxlength="6" pattern="\d{6}" placeholder="123456" style="margin-bottom:8px;padding:10px 12px;font-size:1.25em;letter-spacing:6px;text-align:center;border-radius:7px;border:1.3px solid #b3d6f7;width:140px;" />
      </div>

      <div id="loginActions" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
  <button id="sendCodeBtn" type="button" style="padding:8px 10px;font-size:0.9em;font-weight:600;background:#16a085;color:#fff;border:none;border-radius:8px;cursor:pointer;">Sign in</button>
        <button id="verifyCodeBtn" type="button" style="padding:8px 10px;font-size:0.9em;font-weight:600;background:#2b8a3e;color:#fff;border:none;border-radius:8px;cursor:pointer;display:none;">Verify</button>
        <button id="resendBtn" type="button" style="padding:8px 10px;font-size:0.85em;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:8px;cursor:pointer;display:none;">Resend</button>
      </div>
      <div id="loginMsg" style="margin-top:6px;color:red;font-size:0.98em;"></div>
    </form>
  </div>
  <div class="container" id="dashboardContainer" style="display:none;">
    <nav class="sidebar">
      <h2>Attendance System</h2>
    <div style="position:relative;">
      <button id="studentsBtn" class="active">Students Info</button>
    </div>
  <button id="eventsBtn">Event Management</button>
  <button id="analyticsBtn">Reports</button>
    <button id="studentAnalyticsBtn">Student Analytics</button>
    <button id="ecertificateBtn">E-Certificate</button>
      <div class="sidebar-footer">University of Rizal System - Morong Campus</div>
    </nav>
    <main class="main">
      <section id="ecertificateSection" class="card" style="display:none;background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 48px;margin-bottom:28px;">
  <div id="ecertificateContentBox" style="width:100%;max-width:1100px;margin:0 auto;font-family:'Segoe UI',Arial,sans-serif;color:#000;">
          <div style="width:100%;max-width:1100px;margin:0 auto;font-family:'Segoe UI',Arial,sans-serif;">
            <div style="font-size:1.6em;font-weight:600;color:#1a2233;margin-bottom:10px;letter-spacing:0.5px;text-align:left;">E-Certificate Dashboard</div>
            <div style="background: rgba(255,255,255,0.18);border-radius:10px;padding:12px 14px 10px 14px;margin-bottom:8px;border:1px solid rgba(0,0,0,0.06);">
              <div style="display: flex; align-items: center; width: 100%; gap: 10px;">
                <label for="ecertEventSelect" style="font-size:0.92em;font-weight:500;color:#1a2233;white-space:nowrap;margin-right:4px;">Select Event:</label>
                <select id="ecertEventSelect" style="width:370px;padding:6px 10px;border-radius:7px;border:1.5px solid #159c85;font-size:0.92em;background:rgba(247,249,251,0.7);margin-right:18px;">
                  <option value="">Loading events...</option>
                </select>
                <label for="ecertSearchInput" style="font-size:0.92em;font-weight:500;color:#1a2233;white-space:nowrap;margin-right:4px;">Enter a valid name or email:</label>
                <input id="ecertSearchInput" type="text" placeholder="" style="width:370px;padding:6px 10px;border-radius:7px;border:1.5px solid #159c85;font-size:0.92em;background:rgba(247,249,251,0.7);">
              </div>
              <script>
                (function(){
                  async function loadEcertEvents() {
                    const select = document.getElementById('ecertEventSelect');
                    if (!select) return;
                    try {
                      const res = await fetch('/events');
                      if (!res.ok) throw new Error('Failed to fetch events');
                      const list = await res.json();
                      // sort by createdAt desc if available
                      if (Array.isArray(list)) list.sort((a,b) => (new Date(b.createdAt || 0)) - (new Date(a.createdAt || 0)));
                      select.innerHTML = '';
                      if (!Array.isArray(list) || list.length === 0) {
                        select.innerHTML = '<option value="">No events</option>';
                        return;
                      }
                      list.forEach((ev, idx) => {
                        const opt = document.createElement('option');
                        opt.value = ev._id || ev.id || idx;
                        opt.textContent = ev.name || (`Event ${idx+1}`);
                        select.appendChild(opt);
                      });
                      // select the first (most recent) by default
                      select.selectedIndex = 0;
                      const chosenId = select.value;
                      const chosen = list.find(x => String(x._id) === String(chosenId)) || list[0];
                      // dispatch custom event for other code
                      select.dispatchEvent(new CustomEvent('ecertEventChange', { detail: { eventId: chosenId, event: chosen } }));
                      // wire change handler
                      select.addEventListener('change', function() {
                        const id = this.value;
                        const ev = list.find(x => String(x._id) === String(id));
                        this.dispatchEvent(new CustomEvent('ecertEventChange', { detail: { eventId: id, event: ev } }));
                      });
                    } catch (e) {
                      try { select.innerHTML = '<option value="">Failed to load</option>'; } catch(_){}
                      console && console.error && console.error('ecert events load error', e);
                    }
                  }
                  // load on DOM ready and also when the section is shown
                  document.addEventListener('DOMContentLoaded', loadEcertEvents);
                  // If the app toggles sections, listen for custom show events - conservative: also load when button clicked
                  document.getElementById('ecertificateBtn')?.addEventListener('click', loadEcertEvents);
                })();
              </script>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:4px;align-items:center;">
              <div style="flex:1;background:rgba(255,255,255,0.18);border-radius:10px;padding:8px 0;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-size:1.0em;">
                <div id="ecertPendingCount" style="font-size:1.25em;font-weight:700;color:#1abc9c;">0</div>
                <div style="font-size:0.88em;color:#0a4b8c;font-weight:600;color:#000;">Pending Certificates</div>
              </div>
              <div style="flex:1;background:rgba(255,255,255,0.18);border-radius:10px;padding:8px 0;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-size:1.0em;">
                <div id="ecertSentCount" style="font-size:1.25em;font-weight:700;color:#1abc9c;">0</div>
                <div style="font-size:0.88em;color:#000;font-weight:600;">Certificates Sent</div>
              </div>
              <div style="flex:1;background:rgba(255,255,255,0.18);border-radius:10px;padding:8px 0;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-size:1.0em;">
                <div id="ecertUnqualifiedCount" style="font-size:1.25em;font-weight:700;color:#000;">0</div>
                <div style="font-size:0.88em;color:#000;font-weight:600;">Unqualified Students</div>
              </div>
              <button id="simulateBatchBtn" style="background:#1abc9c;color:#fff;font-weight:600;border:none;border-radius:10px;padding:8px 0;box-shadow:0 2px 8px rgba(0,0,0,0.06);font-size:0.92em;transition:background 0.2s;display:flex;align-items:center;justify-content:center;flex:1;min-height:60px;min-width:140px;transform:translateY(-4px);">Simulate Batch Send</button>
            </div>
            <!-- Filter status moved below the table (kept for later insertion) -->
            <div style="position:relative;max-height:420px;overflow:auto;margin-top:0px;">
                <table id="ecertTable" style="width:100%;table-layout:fixed;border-collapse:collapse;font-size:0.86em;background: rgba(255,255,255,0.18);border-radius:10px;box-shadow:0 1px 4px rgba(44,62,80,0.04);overflow:hidden;backdrop-filter: blur(1.5px);">
        <thead>
          <tr style="background:#f5f5f5;color:#222;font-size:0.92em;">
                    <th style="padding:8px 6px;font-weight:700;width:48px;min-width:48px;">ID</th>
                    <th style="padding:8px 6px;font-weight:700;width:180px;min-width:120px;">RECIPIENT NAME</th>
                    <th style="padding:8px 6px;font-weight:700;width:160px;min-width:110px;">EMAIL ADDRESS</th>
                    <th style="padding:8px 6px;font-weight:700;width:100px;min-width:70px;text-align:center;">TIME IN</th>
                    <th style="padding:8px 6px;font-weight:700;width:100px;min-width:70px;text-align:center;">TIME OUT</th>
                    <th style="padding:8px 6px;font-weight:700;width:100px;min-width:70px;text-align:center;">CERT STATUS</th>
                    <!-- ACTION column removed as requested -->
                  </tr>
                </thead>
                <tbody id="ecertTbody"></tbody>
              </table>
              <div style="font-size:0.92em;color:#888;margin-top:6px;" id="ecertNote">*Only students with both <b>Time In</b> and <b>Time Out</b> are considered qualified recipients.</div>
              <script>
                (function(){
                  const select = document.getElementById('ecertEventSelect');
                  const tbody = document.getElementById('ecertTbody');
                  const searchInput = document.getElementById('ecertSearchInput');
                  const pendingCountEl = document.getElementById('ecertPendingCount');
                  const sentCountEl = document.getElementById('ecertSentCount');
                  const unqCountEl = document.getElementById('ecertUnqualifiedCount');
                  // status filter (dispatched from filter bar)
                  let currentStatusFilter = 'all';
                  document.addEventListener('ecertFilterChange', function(e){ 
                    currentStatusFilter = e.detail && e.detail.filter ? e.detail.filter : 'all'; 
                    // call the render function stored on tbody when available
                    try { if (tbody && typeof tbody._renderRows === 'function') tbody._renderRows(); } catch(_){}
                  });

                  async function fetchDataForEvent(eventId) {
                    if (!eventId) {
                      tbody.innerHTML = '<tr><td colspan="6" style="padding:10px;color:#666;">No event selected.</td></tr>';
                      pendingCountEl.textContent = '0'; sentCountEl.textContent = '0'; unqCountEl.textContent = '0';
                      return;
                    }
                    try {
                      const [studentsRes, logsRes, eventsRes] = await Promise.all([
                        fetch('/students'),
                        fetch(`/logs?eventId=${eventId}`),
                        fetch('/events')
                      ]);
                      const students = studentsRes.ok ? await studentsRes.json() : [];
                      const logs = logsRes.ok ? await logsRes.json() : [];
                      const events = eventsRes.ok ? await eventsRes.json() : [];
                      const ev = events.find(x => String(x._id) === String(eventId)) || null;
                      // normalize participants
                      let participants = { sections: [], students: [] };
                      if (ev) {
                        if (Array.isArray(ev.participants)) participants.sections = ev.participants;
                        else if (ev.participants && typeof ev.participants === 'object') {
                          participants.sections = Array.isArray(ev.participants.sections) ? ev.participants.sections : [];
                          participants.students = Array.isArray(ev.participants.students) ? ev.participants.students : [];
                        }
                      }

                      // Determine participant student set
                      const studentMapByNo = {};
                      const studentMapByFID = {};
                      (students || []).forEach(s => {
                        if (s && s['STUDENT NO']) studentMapByNo[String(s['STUDENT NO']).toLowerCase()] = s;
                        if (s && typeof s.FID !== 'undefined') studentMapByFID[String(s.FID)] = s;
                      });

                      let participantStudents = [];
                      const secSet = new Set((participants.sections || []).map(x => String(x)));
                      const studNoSet = new Set((participants.students || []).map(x => String(x).toLowerCase()));
                      if (secSet.has('ALL')) {
                        participantStudents = students.slice();
                      } else {
                        participantStudents = students.filter(s => (s['YR AND SEC'] && secSet.has(String(s['YR AND SEC']))) || (s['STUDENT NO'] && studNoSet.has(String(s['STUDENT NO']).toLowerCase())));
                      }

                      // Map logs by FID
                      const logsByFID = {};
                      (logs || []).forEach(l => { logsByFID[String(l.fingerprintID)] = l; });

                      // Build current data list with status
                      const rows = (participantStudents || []).map(s => {
                        const fidKey = String(s.FID);
                        const log = logsByFID[fidKey] || null;
                        const hasIn = log && log.timeIn;
                        const hasOut = log && log.timeOut;
                        const qualified = !!(hasIn && hasOut);
                        // detect if certStatus exists on the attendance log (set by server after successful send)
                        const certStatusRaw = log && (log.certStatus || log.cert_status || log.certSent || null);
                        const certStatus = certStatusRaw ? String(certStatusRaw).toLowerCase() : null;
                        // status: 'sent' when certStatus indicates sent; otherwise 'pending' for qualified, 'unqualified' for not qualified
                        let status = 'unqualified';
                        if (certStatus === 'sent') status = 'sent';
                        else if (qualified) status = 'pending';
                        else status = 'unqualified';
                        return { student: s, log, qualified, status };
                      });

                      // store in DOM for render and filtering
                      tbody._ecertRows = rows;
                      // expose renderRows for external triggers (filter buttons)
                      tbody._renderRows = renderRows;
                      renderRows();

                      function renderRows() {
                        const q = (searchInput && searchInput.value || '').trim().toLowerCase();
                        const allRows = tbody._ecertRows || [];
                        // apply status filter
                        let filtered = allRows.filter(r => {
                          if (currentStatusFilter === 'all') return true;
                          if (currentStatusFilter === 'pending') return r.status === 'pending';
                          if (currentStatusFilter === 'sent') return r.status === 'sent'; // placeholder: backend support required
                          return r.status === currentStatusFilter;
                        });
                        // apply search
                        if (q) filtered = filtered.filter(r => {
                          const s = r.student || {};
                          return String(s['STUDENT NO'] || '').toLowerCase().includes(q) || String(s.NAME || '').toLowerCase().includes(q) || String(s.EMAIL || '').toLowerCase().includes(q);
                        });

                        // counts: sent are those explicitly marked sent; pending are qualified but not sent
                        const sentCount = allRows.filter(r => r.status === 'sent').length;
                        const pendingCount = allRows.filter(r => r.status === 'pending').length;
                        const unqCount = allRows.filter(r => r.status === 'unqualified').length;
                        pendingCountEl.textContent = pendingCount;
                        sentCountEl.textContent = sentCount;
                        unqCountEl.textContent = unqCount;

                        if (!filtered || filtered.length === 0) {
                          tbody.innerHTML = '<tr><td colspan="6" style="padding:10px;color:#666;">No participants found for this selection.</td></tr>';
                          return;
                        }
                        tbody.innerHTML = '';
                        filtered.forEach(r => {
                          const s = r.student || {};
                          const log = r.log || {};
                          const timeIn = log.timeIn ? new Date(log.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
                          const timeOut = log.timeOut ? new Date(log.timeOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
                          // Render CERT STATUS badge: Sent (green), Pending/Qualified (teal), Unqualified (red)
                          let statusHtml = "<span style='background:#fff0f0;color:#a40d0d;padding:4px 8px;border-radius:6px;font-weight:600;font-size:0.88em;display:inline-block;white-space:nowrap;'>Unqualified</span>";
                          if (r.status === 'sent') {
                            statusHtml = "<span style='background:#e6f4ea;color:#0b6b2c;padding:4px 8px;border-radius:6px;font-weight:700;font-size:0.88em;display:inline-block;white-space:nowrap;'>Sent</span>";
                          } else if (r.status === 'pending') {
                            statusHtml = "<span style='background:#e8f5ea;color:#1b5e20;padding:4px 8px;border-radius:6px;font-weight:600;font-size:0.88em;display:inline-block;white-space:nowrap;'>Qualified</span>";
                          }
                          // ACTION column removed; render remaining columns only
                          const tr = `<tr style='background:#fff;font-size:0.86em;'>
                            <td style='padding:6px 6px;vertical-align:middle;width:48px;min-width:48px;'>${s.FID ?? ''}</td>
                            <td title='${(s.NAME||'').replace(/'/g, "&#39;")}' style='padding:6px 6px 6px 6px;vertical-align:middle;width:180px;min-width:120px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left;'>${s.NAME ?? ''}</td>
                            <td title='${(s.EMAIL||'').replace(/'/g, "&#39;")}' style='padding:6px 6px 6px 6px;vertical-align:middle;width:160px;min-width:110px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left;'>${s.EMAIL ?? ''}</td>
                            <td style='padding:6px 6px;vertical-align:middle;text-align:center;width:100px;min-width:70px;white-space:nowrap;'>${timeIn}</td>
                            <td style='padding:6px 6px;vertical-align:middle;text-align:center;width:100px;min-width:70px;white-space:nowrap;'>${timeOut}</td>
                            <td style='padding:6px 6px;vertical-align:middle;text-align:center;width:100px;min-width:70px;white-space:nowrap;'>${statusHtml}</td>
                          </tr>`;
                          tbody.innerHTML += tr;
                        });
                      }
                      // wire search input
                      if (searchInput) {
                        searchInput.oninput = function() { renderRows(); };
                      }
                    } catch (e) {
                      console && console.error && console.error('ecert fetch error', e);
                      tbody.innerHTML = '<tr><td colspan="6" style="padding:10px;color:#666;">Failed to load participants.</td></tr>';
                    }
                  }

                  // listen for selection changes
                  select && select.addEventListener('ecertEventChange', function(e){
                    const id = e.detail && e.detail.eventId ? e.detail.eventId : select.value;
                    fetchDataForEvent(id);
                  });
                  // Also run on initial load if a selection exists
                  document.addEventListener('DOMContentLoaded', function(){
                    const initialId = select ? select.value : null;
                    if (initialId) fetchDataForEvent(initialId);
                  });
                })();
              </script>
              <script>
              (function(){
                const btn = document.getElementById('simulateBatchBtn');
                const select = document.getElementById('ecertEventSelect');
                const tbody = document.getElementById('ecertTbody');
                if (!btn) return;
                btn.addEventListener('click', async function(){
                  try {
                    const eventId = select ? select.value : null;
                    const eventName = document.getElementById('ecertDisplayName')?.textContent || '';
                    if (!eventId) return alert('No event selected');
                    // extract qualified rows from tbody._ecertRows
                    const rows = tbody && tbody._ecertRows ? tbody._ecertRows : [];
                    const qualified = (rows || []).filter(r => r.qualified).map(r => {
                      const s = r.student || {};
                      const log = r.log || {};
                      return {
                        FID: s.FID,
                        'STUDENT NO': s['STUDENT NO'],
                        NAME: s.NAME,
                        EMAIL: s.EMAIL,
                        TIME_IN: log.timeIn ? new Date(log.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
                        TIME_OUT: log.timeOut ? new Date(log.timeOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''
                      };
                    });
                    if (!qualified.length) return alert('No qualified recipients to send.');
                    btn.disabled = true; btn.textContent = 'Sending...';
                    const res = await fetch('/send-certs', {
                      method: 'POST', headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ eventId, eventName, participants: qualified })
                    });
                    const data = await res.json();
                    console.log('send-certs result', data);
                    // If server forwarded successfully, re-fetch event logs so certStatus changes are reflected
                    try {
                      if (data && (data.forwarded || data.markedAttendance >= 0)) {
                        // show a clearer alert including how many attendance rows were marked
                        const marked = typeof data.markedAttendance !== 'undefined' ? data.markedAttendance : null;
                        alert('Send completed. ' + (marked !== null ? (marked + ' attendance records marked as Sent.') : 'Server forwarded to GAS.'));
                        // Trigger the same event the event-select handler listens for to reload data
                        select && select.dispatchEvent && select.dispatchEvent(new CustomEvent('ecertEventChange', { detail: { eventId: eventId } }));
                      } else {
                        alert('GAS response: ' + (data && data.gasResponse && data.gasResponse.statusCode ? ('status ' + data.gasResponse.statusCode) : JSON.stringify(data)));
                      }
                    } catch (e) { console && console.error && console.error('post-send refresh error', e); }
                  } catch (e) {
                    console && console.error && console.error('simulate send error', e);
                    alert('Failed to send: ' + (e && e.message ? e.message : e));
                  } finally { btn.disabled = false; btn.textContent = 'Simulate Batch Send'; }
                });
              })();
              </script>
              <div style="margin-top:12px;margin-bottom:16px;display:flex;flex-direction:column;gap:6px;position:sticky;bottom:0;z-index:6;background:linear-gradient(180deg,#f7fdfb,#e8f7f2);padding:10px;border-radius:10px;border:1px solid rgba(16,120,100,0.06);box-shadow:0 6px 18px rgba(16,120,100,0.08);">
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <span style="font-size:0.97em;font-weight:600;color:#074c3a;margin-right:6px;">Filter Status:</span>
                  <button class="ecert-filter-btn" data-filter="all" style="background:transparent;color:#074c3a;border:1px solid rgba(7,76,58,0.12);border-radius:6px;padding:6px 12px;font-size:0.95em;font-weight:600;">Show All</button>
                  <button class="ecert-filter-btn" data-filter="pending" style="background:transparent;color:#074c3a;border:1px solid rgba(7,76,58,0.12);border-radius:6px;padding:6px 12px;font-size:0.95em;font-weight:600;">Show Qualified Only</button>
                  <button class="ecert-filter-btn" data-filter="sent" style="background:transparent;color:#074c3a;border:1px solid rgba(7,76,58,0.12);border-radius:6px;padding:6px 12px;font-size:0.95em;font-weight:600;">Show Sent Only</button>
                  <!-- 'Show Error Only' removed as requested -->
                </div>
                <script>
                (function(){
                  try {
                    var container = document.currentScript.parentElement;
                    var btns = container.querySelectorAll('.ecert-filter-btn');
                    // no checkbox: simplified filter controls
                    function resetStyles(b){ b.style.background = 'transparent'; b.style.color = '#074c3a'; b.style.boxShadow = 'none'; }
                    // initialize: make first button active and dispatch its filter
                    if (btns.length) {
                      btns.forEach(resetStyles);
                      btns[0].style.background = '#0f8b6e'; btns[0].style.color = '#fff'; btns[0].style.boxShadow = '0 2px 6px rgba(15,139,110,0.18)';
                      // dispatch initial filter so table renders accordingly
                      window.dispatchEvent(new CustomEvent('ecertFilterChange', { detail: { filter: btns[0].dataset.filter } }));
                    }
                    btns.forEach(function(b){
                      b.addEventListener('click', function(){
                        btns.forEach(resetStyles);
                        b.style.background = '#1abc9c'; b.style.color = '#fff'; b.style.boxShadow = '0 2px 6px rgba(17,153,119,0.18)';
                        // dispatch event on document so the listener inside fetchDataForEvent picks it up
                        var ev = new CustomEvent('ecertFilterChange', { detail: { filter: b.dataset.filter } });
                        document.dispatchEvent(ev);
                      });
                    });
                  } catch(e) { console && console.error && console.error(e); }
                })();
                </script>
              </div>
            </div>
          </div>
        </div>
      </section>
  <section id="studentsSection" class="card" style="background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 48px;">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <h2 style="color:#1a2233;font-weight:600;letter-spacing:0.7px;font-family:Segoe UI, Arial, sans-serif;">Registered Students</h2>
    <!-- Plus icon moved into Students card header -->
    <button id="studentsCardAddBtn" title="Add student" style="width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(180deg,#16a085,#0f9b82);color:#fff;font-size:20px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;">+</button>
  </div>
    <div style="display:flex;gap:18px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="searchStudentNo" style="font-weight:500;color:#34495e;font-size:0.95em;">Search by Student Number:</label>
  <input type="text" id="searchStudentNo" placeholder="" style="width:120px; font-size:0.92em; padding:5px 7px; margin-left:0; color:#1a2233; border:1.5px solid #d3dbe3; background:#f7f9fb;">
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <label for="filterYrSec" style="font-weight:500;color:#34495e;font-size:0.95em;">Filter by Year and Section:</label>
        <select id="filterYrSec" style="width:160px; font-size:0.92em; padding:5px 7px; margin-left:0; color:#1a2233; border:1.5px solid #d3dbe3; background:#f7f9fb;"></select>
      </div>
      
    </div>
  <table style="background: rgba(255,255,255,0.35); border-radius: 14px; overflow: hidden; box-shadow: 0 1px 4px rgba(44,62,80,0.04); backdrop-filter: blur(1.5px);">
      <thead>
        <tr style='background:#eef2f6;'>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>FID</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>STUDENT NO</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>NAME</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>SEX</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>YR AND SEC</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:left; padding:10px 8px;'>EMAIL</th>
          <th style="font-weight:700; color:#2c3e50; font-size:0.88em; letter-spacing:0.5px; text-align:center; padding:10px 8px;">ACTIONS</th>
        </tr>
      </thead>
      <tbody id="studentTable"></tbody>
    </table>
  </section>
  <section id="enrollSection" class="card" style="display:none;background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:14px 32px;position:relative;max-width:720px;">
  <h2 style="color:#16a085;font-weight:700;letter-spacing:0.7px;font-family:Segoe UI, Arial, sans-serif;">Enroll New Student</h2>
    <!-- Close control inside enroll card (works when used in modal too) -->
    <button id="enrollCardCloseBtn" title="Close" style="position:absolute;top:14px;right:18px;width:34px;height:34px;border-radius:50%;border:none;background:#f44336;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(44,62,80,0.12);font-weight:700;">âœ•</button>
    <form id="enrollForm" style="max-width:720px;">
      <!-- Wrapper ensures both rows have same total width -->
      <div style="width:560px;max-width:100%;">
      <!-- Row 1: compact inputs for FID, Student No, Year & Section, Sex -->
      <div style="width:560px;max-width:100%;display:flex;gap:10px;align-items:flex-end;">
        <div class="form-group" style="flex:0 0 90px;min-width:80px;">
          <label for="enrollFID">FID</label>
          <input type="number" id="enrollFID" required min="1" step="1" placeholder="#" style="padding:6px 8px;font-size:0.95em;">
        </div>
        <div class="form-group" style="flex:1 1 40%;min-width:120px;">
          <label for="enrollStudentNo">Student No.</label>
          <input type="text" id="enrollStudentNo" required placeholder="e.g. M2022-1001" style="padding:6px 8px;font-size:0.95em;">
        </div>
        <div class="form-group" style="flex:1 1 40%;min-width:110px;">
          <label for="enrollYrSec">Year &amp; Sec</label>
          <select id="enrollYrSec" required style="padding:6px 8px;font-size:0.95em;">
            <option value="">Select</option>
            <option value="1ECE-A">1ECE-A</option>
            <option value="1ECE-B">1ECE-B</option>
            <option value="2ECE-A">2ECE-A</option>
            <option value="2ECE-B">2ECE-B</option>
            <option value="3ECE-A">3ECE-A</option>
            <option value="3ECE-B">3ECE-B</option>
            <option value="4ECE-A">4ECE-A</option>
            <option value="4ECE-B">4ECE-B</option>
          </select>
        </div>
        <div class="form-group" style="flex:0 0 110px;min-width:90px;">
          <label for="enrollSex">Sex</label>
          <select id="enrollSex" required style="padding:6px 8px;font-size:0.95em;">
            <option value="">Sex</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </div>
      </div>

      <!-- Row 2: Name and Email side-by-side - constrained to same wrapper width -->
      <div style="width:560px;max-width:100%;margin-top:12px;display:flex;gap:10px;">
        <div class="form-group" style="flex:1 1 50%;min-width:220px;">
          <label for="enrollName">Name</label>
          <input type="text" id="enrollName" required style="padding:8px 10px;font-size:0.95em;">
        </div>
        <div class="form-group" style="flex:1 1 50%;min-width:220px;">
          <label for="enrollEmail">Email</label>
          <input type="email" id="enrollEmail" required style="padding:8px 10px;font-size:0.95em;">
        </div>
      </div>

      <!-- Bulk CSV import controls (inside Enroll popup) -->
      <div style="width:560px;max-width:100%;margin-top:12px;display:flex;gap:10px;align-items:center;">
        <label style="font-weight:600;color:#34495e;">Or import CSV:</label>
        <input id="studentsCsvFile" type="file" accept=".csv" style="font-size:0.92em;" />
        <button id="uploadStudentsCsvBtn" type="button" style="background:#0f8b6e;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600;">Upload CSV</button>
      </div>

      <div style="margin-top:12px;">
        <button type="submit">Enroll Student</button>
      </div>
    </form>
  <div id="enrollMsg" style="margin-top:8px;color:green;"></div>
  </section>
  <script>
  // Bulk upload students CSV handler
  (function(){
    const fileInput = document.getElementById('studentsCsvFile');
    const btn = document.getElementById('uploadStudentsCsvBtn');
    if (!fileInput || !btn) return;
    btn.addEventListener('click', async function(){
      const f = fileInput.files && fileInput.files[0];
      if (!f) return alert('Select a CSV file first');
      const text = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error);
        r.readAsText(f);
      });
      // send CSV to server as JSON { csv: '...' }
      try {
        btn.disabled = true; btn.textContent = 'Uploading...';
        const res = await fetch('/students/bulk', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ csv: text }) });
        const j = await res.json();
        if (!res.ok) {
          alert('Upload failed: ' + (j && j.error ? j.error : JSON.stringify(j)));
        } else {
          alert('Upload complete. Summary:\n' + JSON.stringify(j.summary, null, 2));
          // refresh students cache and table
          try { if (typeof updateStudentsCache === 'function') updateStudentsCache(); } catch(e){}
          try { fetchStudents().then(studs => { renderStudentsTable(studs || []); }); } catch(e){}
        }
      } catch (e) { alert('Upload error: ' + (e && e.message ? e.message : e)); }
      finally { btn.disabled = false; btn.textContent = 'Upload CSV'; }
    });
  })();
  // Enroll modal: reuse the existing #enrollSection as modal content to avoid duplicating form logic
  (function(){
    const enrollSection = document.getElementById('enrollSection');
    if (!enrollSection) return;
    // Keep a placeholder to restore enrollSection when modal closed
    const enrollPlaceholder = document.createElement('div');
    enrollPlaceholder.id = 'enrollPlaceholder';

    function openEnrollModal() {
      // If modal already present, do nothing
      if (document.getElementById('enrollModalOverlay')) return;
      // Replace enrollSection with placeholder to remember original position
      const parent = enrollSection.parentElement;
      if (parent && enrollSection) parent.replaceChild(enrollPlaceholder, enrollSection);

      // Create overlay
      const overlay = document.createElement('div');
      overlay.id = 'enrollModalOverlay';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100vw';
      overlay.style.height = '100vh';
      overlay.style.background = 'rgba(0,0,0,0.18)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '100000';

      // Modal box
      const box = document.createElement('div');
      box.style.background = '#fff';
      box.style.borderRadius = '12px';
      box.style.padding = '18px';
      box.style.minWidth = '360px';
      box.style.maxWidth = '92vw';
      box.style.maxHeight = '90vh';
      box.style.overflow = 'auto';
      box.style.boxShadow = '0 12px 40px rgba(44,62,80,0.20)';

      // Move enrollSection into box
      box.appendChild(enrollSection);

  overlay.appendChild(box);
  document.body.appendChild(overlay);

      // Show enrollSection (it was display:none)
      enrollSection.style.display = 'block';

      // Close when clicking outside box
      overlay.addEventListener('mousedown', function(ev){ if (ev.target === overlay) closeEnrollModal(); });
      // Close on Escape
      function escListener(e){ if (e.key === 'Escape') closeEnrollModal(); }
      document.addEventListener('keydown', escListener);

      // Auto-close after enrollment has been disabled so the user can manually close the modal.
      // Enrollment feedback will still be shown in #enrollMsg but the modal will remain open until the user closes it.

      function closeEnrollModal() {
        // disconnect observer
        if (overlay._enrollObserver) try { overlay._enrollObserver.disconnect(); } catch(e){}
        // Hide enrollSection and move back to original position
        enrollSection.style.display = 'none';
        const ph = document.getElementById('enrollPlaceholder');
        if (ph && ph.parentElement) ph.parentElement.replaceChild(enrollSection, ph);
        // remove overlay
        if (overlay && overlay.parentElement) overlay.parentElement.removeChild(overlay);
        document.removeEventListener('keydown', escListener);
      }
      // Listen for a custom event dispatched by the in-card close button
      overlay.addEventListener('closeEnrollModal', function(){ closeEnrollModal(); });

      // If the in-card close button exists (inside enrollSection), wire it to close the modal via event
      const cardClose = document.getElementById('enrollCardCloseBtn');
      if (cardClose) {
        cardClose.onclick = function() {
          // Dispatch event on overlay so listener above can close it
          overlay.dispatchEvent(new Event('closeEnrollModal'));
        };
      }
    }

    // Wire up buttons: students card + and sidebar enrollBtn
    document.addEventListener('DOMContentLoaded', function(){
      const cardBtn = document.getElementById('studentsCardAddBtn');
      const sideEnroll = document.getElementById('enrollBtn');
      if (cardBtn) cardBtn.addEventListener('click', openEnrollModal);
      if (sideEnroll) sideEnroll.addEventListener('click', function(e){ e.preventDefault(); openEnrollModal(); });
    });
  })();
  </script>
  <script>
    // Ensure the in-card close button works both when enrollSection is inside the modal
    // and when it's shown inline (fallback).
    document.addEventListener('DOMContentLoaded', function() {
      const cardClose = document.getElementById('enrollCardCloseBtn');
      if (!cardClose) return;
      cardClose.addEventListener('click', function() {
        const overlay = document.getElementById('enrollModalOverlay');
        if (overlay) {
          overlay.dispatchEvent(new Event('closeEnrollModal'));
        } else {
          const enrollSection = document.getElementById('enrollSection');
          if (enrollSection) enrollSection.style.display = 'none';
        }
      });
    });
  </script>
  <section id="eventsSection" class="card" style="display:none;background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 48px;">
  <h2 style="color:#1a2233;font-weight:600;letter-spacing:0.7px;font-family:Segoe UI, Arial, sans-serif;margin-bottom:6px;">Event Management</h2>
    <div style="display:flex;align-items:center;margin-bottom:8px;">
  <button id="showAddEventPopupBtn" style="height:40px;padding:0 22px;font-size:1.08em;font-weight:600;background:#1abc9c;color:#fff;border:none;border-radius:8px;cursor:pointer;">Add Event</button>
  <button id="showSetActiveEventBtn" style="margin-left:10px;height:40px;padding:0 18px;font-size:1.02em;font-weight:600;background:#1abc9c;color:#fff;border:none;border-radius:8px;cursor:pointer;">Set Active Event</button>
      <span id="eventMsg" style="margin-left:16px;color:green;"></span>
    </div>
    <script>
    // Add Event Popup logic
    document.addEventListener("DOMContentLoaded", function() {
      const showAddEventPopupBtn = document.getElementById("showAddEventPopupBtn");
      if (showAddEventPopupBtn) {
        showAddEventPopupBtn.onclick = function() {
          // Remove any existing popup
          const old = document.getElementById('addEventPopup');
          if (old) old.remove();
          // Create popup
          const popup = document.createElement('div');
          popup.id = 'addEventPopup';
          popup.style.position = 'fixed';
          popup.style.top = '0';
          popup.style.left = '0';
          popup.style.width = '100vw';
          popup.style.height = '100vh';
          popup.style.background = 'rgba(0,0,0,0.15)';
          popup.style.display = 'flex';
          popup.style.alignItems = 'center';
          popup.style.justifyContent = 'center';
          popup.style.zIndex = '9999';
          // Get YR AND SEC options from studentsCache
          let sectionOptions = '<option value="ALL">All</option>';
          if (window.studentsCache && Array.isArray(window.studentsCache)) {
            const secSet = new Set();
            window.studentsCache.forEach(s => {
              if (s["YR AND SEC"]) secSet.add(s["YR AND SEC"]);
            });
            sectionOptions += Array.from(secSet).sort().map(sec => `<option value="${sec}">${sec}</option>`).join("");
          }
          popup.innerHTML = `
            <div style="background:#fff;padding:32px 24px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.12);min-width:340px;max-width:90vw;display:flex;flex-direction:column;align-items:center;">
              <h3 style='margin-top:0; margin-bottom:18px; color:#1abc9c; font-size:1.3em; font-weight:700;'>Add Event</h3>
              <form id='eventForm' style='width:100%;display:flex;flex-direction:column;gap:14px;'>
                <div style='display:flex;flex-direction:row;gap:12px;'>
                  <div style='flex:1;display:flex;flex-direction:column;gap:6px;'>
                    <label for='eventName' style='font-weight:600;'>Event Name</label>
                    <input type='text' id='eventName' required style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                  <div style='flex:1;display:flex;flex-direction:column;gap:6px;'>
                    <label for='eventDate' style='font-weight:600;'>Event Date</label>
                    <input type='date' id='eventDate' required style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                </div>
                <div style='display:flex;flex-direction:row;gap:10px;'>
                  <div style='display:flex;flex-direction:column;gap:6px;flex:1;'>
                    <label for='eventTimeStart' style='font-weight:600;'>Start Time</label>
                    <input type='time' id='eventTimeStart' required style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                  <div style='display:flex;flex-direction:column;gap:6px;flex:1;'>
                    <label for='eventTimeEnd' style='font-weight:600;'>End Time</label>
                    <input type='time' id='eventTimeEnd' required style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                </div>
                <div style='display:flex;flex-direction:column;gap:6px;'>
                  <label style='font-weight:600;'>Participants (Section)</label>
                  <div id='eventParticipantsOptions' style='display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;'></div>
                  <span style='font-size:0.92em;color:#888;margin-top:2px;'>Click sections to select. Selected sections are highlighted. Selecting "All" overrides other selections.</span>
                </div>
                <!-- New: allow adding specific students by their student number -->
                <div style='display:flex;flex-direction:column;gap:6px;margin-top:6px;'>
                  <label style='font-weight:600;'>Participants (By Student Number)</label>
                  <div style='display:flex;gap:8px;align-items:center;'>
                    <input type='text' id='participantStudentNoInput' placeholder='e.g. M2022-1001' style='flex:1;padding:8px;border:1px solid #dcdcdc;border-radius:6px;font-size:0.95em;' />
                    <button type='button' id='addParticipantStudentBtn' style='background:#16a085;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-weight:600;'>Add</button>
                  </div>
                  <div id='selectedStudentParticipants' style='display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;'></div>
                  <span style='font-size:0.92em;color:#888;margin-top:2px;'>Add specific students by their student number. Added students will be included as participants.</span>
                </div>
                <div style='display:flex;justify-content:flex-end;gap:10px;margin-top:8px;'>
                  <button type='submit' style='background:#1abc9c;color:#fff;padding:8px 22px;border:none;border-radius:6px;font-weight:600;'>Add</button>
                  <button type='button' id='cancelAddEventBtn' style='background:#bbb;color:#fff;padding:8px 22px;border:none;border-radius:6px;font-weight:600;'>Cancel</button>
                </div>
                <span id='popupEventMsg' style='color:green;margin-top:6px;'></span>
              </form>
            </div>
          `;
          document.body.appendChild(popup);
          document.getElementById('cancelAddEventBtn').onclick = () => popup.remove();
          const eventForm = document.getElementById('eventForm');
          const popupEventMsg = document.getElementById('popupEventMsg');
          eventForm.onsubmit = async function(e) {
            e.preventDefault();
            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const timeStart = document.getElementById('eventTimeStart').value;
            const timeEnd = document.getElementById('eventTimeEnd').value;
            // Custom participants selection logic
            const selectedSections = window._eventParticipantsSelected || [];
            const specificStudents = window._eventSpecificStudents || [];
            popupEventMsg.textContent = '';
            if (!name || !date || !timeStart || !timeEnd || (selectedSections.length === 0 && specificStudents.length === 0)) {
              popupEventMsg.textContent = 'Please fill in all fields.';
              popupEventMsg.style.color = 'red';
              return;
            }
            try {
        const res = await fetch("/events", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                // Merge section selections and specific student numbers into participants
                body: JSON.stringify({ name, date, timeStart, timeEnd, participants: { sections: selectedSections, students: specificStudents } })
              });
              if (res.ok) {
                popupEventMsg.textContent = "Event added!";
                eventForm.reset();
                await updateEventsCache();
                setTimeout(() => { popup.remove(); }, 1000);
              } else {
                const err = await res.json();
                popupEventMsg.textContent = err.error || "Failed to add event.";
                popupEventMsg.style.color = 'red';
              }
            } catch (error) {
              popupEventMsg.textContent = "Error: " + error.message;
              popupEventMsg.style.color = 'red';
            }
          };
          // --- Custom participants UI logic ---
          const opts = document.getElementById('eventParticipantsOptions');
          // Build options
          let allSections = [];
          if (window.studentsCache && Array.isArray(window.studentsCache)) {
            const secSet = new Set();
            window.studentsCache.forEach(s => { if (s["YR AND SEC"]) secSet.add(s["YR AND SEC"]); });
            allSections = Array.from(secSet).sort();
          }
          allSections = ['ALL', ...allSections];
          window._eventParticipantsSelected = [];
          // Keep specific student numbers separately
          window._eventSpecificStudents = [];
          function renderOptions() {
            opts.innerHTML = '';
            allSections.forEach(sec => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.textContent = sec;
              const isSelected = window._eventParticipantsSelected.includes(sec);
              btn.style.cssText = `background:${isSelected ? '#1abc9c' : '#eafaf6'};color:${isSelected ? '#fff' : '#1a2233'};padding:5px 14px;border-radius:12px;border:none;font-size:0.98em;cursor:pointer;transition:background 0.2s;outline:${isSelected ? '2px solid #159c85' : 'none'};`;
              btn.onclick = function() {
                if (isSelected) {
                  window._eventParticipantsSelected = window._eventParticipantsSelected.filter(s => s !== sec);
                } else if (sec === 'ALL') {
                  window._eventParticipantsSelected = ['ALL'];
                } else {
                  window._eventParticipantsSelected = window._eventParticipantsSelected.filter(s => s !== 'ALL');
                  window._eventParticipantsSelected.push(sec);
                }
                renderOptions();
              };
              opts.appendChild(btn);
            });
          }
          renderOptions();
          // --- Specific student participants logic ---
          const studentInput = document.getElementById('participantStudentNoInput');
          const addStudentBtn = document.getElementById('addParticipantStudentBtn');
          const selectedStudentBox = document.getElementById('selectedStudentParticipants');
          function renderSelectedStudents() {
            selectedStudentBox.innerHTML = '';
            window._eventSpecificStudents.forEach(sn => {
              const chip = document.createElement('div');
              chip.style.cssText = 'background:#f1f5f9;border:1px solid #dfe7ef;padding:6px 10px;border-radius:12px;font-size:0.95em;display:flex;align-items:center;gap:8px;';
              chip.textContent = sn;
              const remove = document.createElement('button');
              remove.type = 'button';
              remove.textContent = 'Ã—';
              remove.style.cssText = 'background:transparent;border:none;color:#666;font-weight:700;cursor:pointer;padding:0 6px;font-size:1.05em;line-height:1;';
              remove.onclick = () => {
                window._eventSpecificStudents = window._eventSpecificStudents.filter(x => x !== sn);
                renderSelectedStudents();
              };
              chip.appendChild(remove);
              selectedStudentBox.appendChild(chip);
            });
          }
          addStudentBtn.addEventListener('click', async function() {
            const val = (studentInput.value || '').trim();
            if (!val) return;
            // Try to resolve student from cache first
            let found = null;
            if (window.studentsCache && Array.isArray(window.studentsCache)) {
              found = window.studentsCache.find(s => String(s['STUDENT NO']).toLowerCase() === val.toLowerCase());
            }
            if (!found) {
              // Fetch from backend by student number
              try {
                const res = await fetch('/students');
                if (res.ok) {
                  const list = await res.json();
                  found = list.find(s => String(s['STUDENT NO']).toLowerCase() === val.toLowerCase());
                }
              } catch (e) { /* ignore */ }
            }
            if (!found) {
              // show temporary message
              const prev = popupEventMsg.textContent;
              popupEventMsg.style.color = 'red';
              popupEventMsg.textContent = 'Student not found: ' + val;
              setTimeout(() => { popupEventMsg.textContent = prev; }, 2200);
              return;
            }
            // Add student number to specific list if not already present
            const sn = String(found['STUDENT NO']);
            if (!window._eventSpecificStudents.includes(sn)) {
              window._eventSpecificStudents.push(sn);
              renderSelectedStudents();
            }
            studentInput.value = '';
          });
        };
      }
    });
    </script>
    <script>
    // Set Active Event modal logic
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('showSetActiveEventBtn');
      if (!btn) return;
      btn.addEventListener('click', async function() {
        // Remove any existing modal
        const old = document.getElementById('setActiveEventModal');
        if (old) old.remove();

        // Ensure we have events to show
        let list = Array.isArray(window.eventsCache) && window.eventsCache.length ? window.eventsCache : null;
        if (!list) {
          try {
                const res = await fetch('/events');
            if (res.ok) list = await res.json();
            else list = [];
          } catch (e) { list = []; }
        }

        // Build modal
        const modal = document.createElement('div');
        modal.id = 'setActiveEventModal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.18)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '100000';

        const box = document.createElement('div');
        box.style.background = '#fff';
        box.style.borderRadius = '12px';
        box.style.padding = '18px';
        box.style.minWidth = '340px';
        box.style.maxWidth = '90vw';
        box.style.maxHeight = '80vh';
        box.style.overflow = 'auto';

        const title = document.createElement('h3');
        title.textContent = 'Set Active Event';
        title.style.marginTop = '0';
        title.style.color = '#1a2233';
        title.style.marginBottom = '10px';
        box.appendChild(title);

        const listContainer = document.createElement('div');
        listContainer.style.display = 'flex';
        listContainer.style.flexDirection = 'column';
        listContainer.style.gap = '8px';

        if (!list || list.length === 0) {
          const empty = document.createElement('div');
          empty.textContent = 'No events available.';
          empty.style.color = '#666';
          listContainer.appendChild(empty);
        } else {
          list.forEach(ev => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            row.style.padding = '8px';
            row.style.border = '1px solid #eef2f6';
            row.style.borderRadius = '8px';

            const label = document.createElement('div');
            label.style.flex = '1';
            label.innerHTML = `<strong style="display:block;">${ev.name}</strong><small style="color:#666;">${ev.date || ''} ${ev.timeStart ? ' ' + ev.timeStart : ''}</small>`;

            const action = document.createElement('div');
            const setBtn = document.createElement('button');
            setBtn.textContent = 'Set Active';
            setBtn.style.background = ev.active ? '#4caf50' : '#16a085';
            setBtn.style.color = '#fff';
            setBtn.style.border = 'none';
            setBtn.style.padding = '6px 12px';
            setBtn.style.borderRadius = '8px';
            setBtn.style.cursor = 'pointer';
            setBtn.onclick = async function() {
              try {
                const res = await fetch('/events/' + ev._id + '/activate', { method: 'POST' });
                if (res.ok) {
                  const msg = document.getElementById('eventMsg');
                  if (msg) { msg.style.color = 'green'; msg.textContent = 'Active event set: ' + ev.name; }
                  await updateEventsCache();
                  modal.remove();
                } else {
                  const err = await res.json().catch(() => ({}));
                  alert(err.error || 'Failed to set active event.');
                }
              } catch (err) {
                alert('Error: ' + err.message);
              }
            };
            action.appendChild(setBtn);

            row.appendChild(label);
            row.appendChild(action);
            listContainer.appendChild(row);
          });
        }

        box.appendChild(listContainer);

        const closeBtn = document.createElement('div');
        closeBtn.innerHTML = 'Close';
        closeBtn.style.marginTop = '12px';
        closeBtn.style.textAlign = 'right';
  closeBtn.style.color = '#16a085';
        closeBtn.style.cursor = 'pointer';
        closeBtn.onclick = () => modal.remove();
        box.appendChild(closeBtn);

        modal.appendChild(box);
        document.body.appendChild(modal);
      });
    });
    </script>
      <table>
        <thead>
          <tr style="height:44px;background:#f0f0f0;">
            <th style="padding:4px 6px;">Name</th>
            <th style="padding:4px 6px;">Date</th>
            <th style="padding:4px 6px;">Time</th>
            <th style="padding:4px 6px;">Participants</th>
            <th style="padding:4px 4px; text-align:center; height:44px;">
              <div style="display:flex;align-items:center;justify-content:center;height:44px;">Attendance Sheet</div>
            </th>
            <th style="padding:4px 4px; text-align:center; height:44px;">
              <div style="display:flex;align-items:center;justify-content:center;height:44px;">Action</div>
            </th>
          </tr>
        </thead>
        <tbody id="eventListTable"></tbody>
      </table>
      <div id="attendanceSheetModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.15); align-items:center; justify-content:center; z-index:9999;"></div>
    </section>
  <section id="analyticsSection" class="card" style="display:none;background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 48px;margin-bottom:18px;">
    <div style="font-size:0.85em;color:#2a3b4a;line-height:1.35;margin-bottom:10px;font-style:italic;text-align:justify;opacity:0.92;">
      This Analytics Dashboard provides a comprehensive analysis of attendance for all Electronics Engineering department events. The key performance indicators and visualizations below are designed to offer actionable insights into student participation and event effectiveness.
    </div>
  <script>
  // Fetch and update analytics summary cards
  async function updateAnalyticsSummaryCards() {
    try {
      const [studentsRes, eventsRes, logsRes] = await Promise.all([
        fetch('/students'),
        fetch('/events'),
        fetch('/logs')
      ]);
      const students = await studentsRes.json();
      const events = await eventsRes.json();
      const logs = await logsRes.json();
      // Total Enrolled ECE Students
      const totalStudents = students.length;
      document.getElementById('totalAbsentCard').textContent = totalStudents;
      // Total ECE Events
      const totalEvents = events.length;
      document.getElementById('totalPresentCard').textContent = totalEvents;
      // Average Attendance Rate (average of per-event attendance rates)
      let avgRate = 0;
      if (events.length > 0) {
        let sumRates = 0;
        let countedEvents = 0;
        events.forEach(ev => {
            // Normalize participants: support legacy array or normalized object { sections: [], students: [] }
            let parts = { sections: [], students: [] };
            if (Array.isArray(ev.participants)) parts.sections = ev.participants;
            else if (ev.participants && typeof ev.participants === 'object') {
              parts.sections = Array.isArray(ev.participants.sections) ? ev.participants.sections : [];
              parts.students = Array.isArray(ev.participants.students) ? ev.participants.students : [];
            }
            // Expected participants for this event
            let expected = 0;
            if (parts.sections.includes('ALL')) {
              expected = students.length;
            } else {
              expected = students.filter(s => parts.sections.includes(s["YR AND SEC"]))?.length || 0;
              // If specific students listed, try to count them (match by STUDENT NO)
              if (parts.students && parts.students.length) {
                const explicitStudents = students.filter(s => parts.students.includes(String(s["STUDENT NO"]) || String(s["STUDENT NO"])));
                // Add only those explicit students not already counted via sections
                expected += explicitStudents.length;
              }
            }
            // Count unique attendees for this event - match by event._id if available
            const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut).map(l => l.fingerprintID));
          const rate = (expected > 0) ? (attendees.size / expected) * 100 : 0;
          if (expected > 0) {
            sumRates += rate;
            countedEvents++;
          }
        });
        avgRate = countedEvents > 0 ? (sumRates / countedEvents) : 0;
      }
      document.getElementById('attendancePercentCard').textContent = avgRate.toFixed(1) + '%';
    } catch (err) {
      // fallback: do not update cards
      console.error('Failed to update analytics summary cards:', err);
    }
  }
  // Update on DOMContentLoaded and when analytics section is shown
  document.addEventListener('DOMContentLoaded', function() {
    updateAnalyticsSummaryCards();
    // Optionally, re-run when analytics section is shown
    const analyticsBtn = document.getElementById('analyticsBtn');
    if (analyticsBtn) {
      analyticsBtn.addEventListener('click', updateAnalyticsSummaryCards);
    }
    // Signal that inline attendance section donut is implemented here
    window._attendanceSectionInlineExists = true;
  });
  </script>
  <div class="report-summary-row" style="display:flex;flex-direction:row;justify-content:center;align-items:stretch;gap:18px;margin:12px 0;width:100%;font-family:Segoe UI, Arial, sans-serif;color:#1a2233;">
  <div class="report-summary-box attendance" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:18px 24px 18px 24px;width:260px !important;min-width:260px !important;max-width:260px !important;flex:0 0 260px !important;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;margin-right:0;min-height:70px;backdrop-filter: blur(2px);box-sizing:border-box;overflow:hidden;">
    <span class="summary-label" style="color:#222;font-size:0.95em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Average Attendance Rate</span>
  <span class="summary-value" id="attendancePercentCard" style="font-size:2.4em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">86.2%</span>
    <span style="font-size:1em;color:#0a4b8c;margin-top:2px;opacity:0.85;text-align:center;">of total capacity</span>
  </div>
  <div class="report-summary-box present" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:18px 24px 18px 24px;width:260px !important;min-width:260px !important;max-width:260px !important;flex:0 0 260px !important;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;margin-right:0;min-height:70px;backdrop-filter: blur(2px);box-sizing:border-box;overflow:hidden;">
    <span class="summary-label" style="color:#222;font-size:0.95em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Total ECE Events</span>
  <span class="summary-value" id="totalPresentCard" style="font-size:2.4em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">18</span>
    <span style="font-size:1em;color:#0a4b8c;margin-top:2px;opacity:0.85;text-align:center;">since start of semester</span>
  </div>
  <div class="report-summary-box absent" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:18px 24px 18px 24px;width:260px !important;min-width:260px !important;max-width:260px !important;flex:0 0 260px !important;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:70px;backdrop-filter: blur(2px);box-sizing:border-box;overflow:hidden;">
    <span class="summary-label" style="color:#222;font-size:0.95em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Total Enrolled ECE Students</span>
  <span class="summary-value" id="totalAbsentCard" style="font-size:2.4em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">450</span>
    <span style="font-size:1em;color:#0a4b8c;margin-top:2px;opacity:0.85;text-align:center;">across all sections</span>
  </div>
  </div>
  <!-- Additional horizontally aligned report sections below main summary -->
  <div class="analytics-extra-row" style="display:flex;flex-direction:row;gap:18px;justify-content:center;align-items:stretch;margin:18px 0 0 0;padding:0;width:100%;">
  <div class="report-summary-box" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:32px 40px;min-width:320px;max-width:600px;flex:1 1 0;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:220px;backdrop-filter: blur(2px);">
  <span class="summary-label" style="color:#111;font-size:1.05em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:6px;line-height:1.2;font-family:Segoe UI, Arial, sans-serif;">Attendance Level Per Event</span>
    <div style="width:440px;max-width:100%;height:250px;display:flex;align-items:center;justify-content:center;margin-bottom:4px;">
      <canvas id="attendanceLevelEventChart" width="420" height="225" style="display:block;"></canvas>
    </div>
    <span style="font-size:1.05em;color:#0a4b8c;margin-top:0.5em;opacity:0.85;text-align:center;">Percentage (%) per event</span>
  <!-- Open Performance Window removed -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  var ctx = document.getElementById('attendanceLevelEventChart');
  if (ctx) {
    Promise.all([
      fetch('/events'),
      fetch('/logs'),
      fetch('/students')
    ]).then(async ([eventsRes, logsRes, studentsRes]) => {
      const events = await eventsRes.json();
      const logs = await logsRes.json();
      const students = await studentsRes.json();
      // Use latest 7 events (by date when available, newest first)
      const eventsSorted = events.slice().sort((a, b) => {
        const da = Date.parse(a.date);
        const db = Date.parse(b.date);
        if (!isNaN(da) && !isNaN(db)) return db - da; // newest first
        if (!isNaN(da)) return -1;
        if (!isNaN(db)) return 1;
        return 0;
      });
      const latestSeven = eventsSorted.slice(0, 7).reverse(); // reverse to show oldest->newest on chart
      const labels = latestSeven.map(ev => ev.name);
      const data = latestSeven.map(ev => {
        // Normalize participants
        let parts = { sections: [], students: [] };
        if (Array.isArray(ev.participants)) parts.sections = ev.participants;
        else if (ev.participants && typeof ev.participants === 'object') {
          parts.sections = Array.isArray(ev.participants.sections) ? ev.participants.sections : [];
          parts.students = Array.isArray(ev.participants.students) ? ev.participants.students : [];
        }
        // Compute expected participants
        let expected = 0;
        if (parts.sections.includes('ALL')) {
          expected = students.length;
        } else {
          expected = students.filter(s => parts.sections.includes(s["YR AND SEC"]))?.length || 0;
          if (parts.students && parts.students.length) {
            const explicit = students.filter(s => parts.students.includes(String(s["STUDENT NO"]) || String(s["STUDENT NO"])));
            expected += explicit.length;
          }
        }
        // Match logs by event._id and count unique attendees
  const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut).map(l => l.fingerprintID));
        return expected > 0 ? (attendees.size / expected) * 100 : 0;
      });
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '',
            data: data,
            fill: true,
            backgroundColor: 'rgba(22,160,133,0.13)',
            borderColor: '#16a085',
            borderWidth: 4,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#16a085',
            pointRadius: 6,
            pointHoverRadius: 8,
            tension: 0.45
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: '#111',
                font: { size: 13, family: 'Segoe UI, Arial, sans-serif', weight: '400' },
                padding: 6
              }
            },
            y: {
              min: 0,
              max: 100,
              grid: { color: 'rgba(120,120,120,0.10)' },
              ticks: {
                color: '#111',
                font: { size: 13, family: 'Segoe UI, Arial, sans-serif', weight: '400' },
                stepSize: 20,
                callback: function(value) { return value + '%'; },
                padding: 4
              },
              title: {
                display: false
              }
            }
          },
          elements: {
            line: { borderJoinStyle: 'round' },
            point: { borderWidth: 3 }
          },
          animation: false
        }
      });
    });
  }
});
</script>
<script>
// Performance Window Modal
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('openPerformanceWindowBtn');
  if (!btn) return;
  btn.addEventListener('click', function() {
    // Remove any existing modal
    var old = document.getElementById('performanceWindowModal');
    if (old) old.remove();
    // Calculate sidebar width
    var sidebar = document.querySelector('.sidebar');
    var sidebarWidth = sidebar ? sidebar.offsetWidth : 210;
    // Create modal overlay
    var modal = document.createElement('div');
    modal.id = 'performanceWindowModal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = sidebarWidth + 'px';
    modal.style.width = 'calc(100vw - ' + sidebarWidth + 'px)';
    modal.style.height = '100vh';
    modal.style.background = 'rgba(0,0,0,0.18)';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '99999';
    // Modal content styled like the dashboard
    var content = document.createElement('div');
    content.style.background = '#fff';
    content.style.borderRadius = '32px';
    content.style.boxShadow = '0 12px 40px rgba(44,62,80,0.20)';
  content.style.minWidth = '600px';
    content.style.minHeight = '520px';
  content.style.maxWidth = '92vw';
    content.style.maxHeight = '98vh';
  content.style.width = 'clamp(600px, 75vw, 950px)';
    content.style.height = 'clamp(520px, 90vh, 700px)';
  content.style.display = 'flex';
  content.style.flexDirection = 'column';
  content.style.position = 'relative';
  content.style.padding = '0';
  content.style.overflow = 'hidden';

    // Header
    var header = document.createElement('div');
    header.style.background = 'linear-gradient(90deg,#e3f0ff 80%,#d0e7ff 100%)';
  header.style.borderTopLeftRadius = '28px';
  header.style.borderTopRightRadius = '28px';
  header.style.padding = '4px 10px 2px 16px';
    header.style.position = 'relative';
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.justifyContent = 'space-between';

    var title = document.createElement('div');
  title.textContent = 'REPORTS';
  title.style.fontSize = '1.18em';
  title.style.fontWeight = '600';
  title.style.letterSpacing = '0.7px';
  title.style.color = '#1a2233';
  title.style.fontFamily = 'Segoe UI, Arial, sans-serif';
    header.appendChild(title);

    var closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.position = 'absolute';
  closeBtn.style.top = '2px';
  closeBtn.style.right = '6px';
  closeBtn.style.width = '24px';
  closeBtn.style.height = '24px';
  closeBtn.style.background = '#f44336';
  closeBtn.style.color = '#fff';
  closeBtn.style.border = 'none';
  closeBtn.style.borderRadius = '50%';
  closeBtn.style.fontSize = '1em';
  closeBtn.style.cursor = 'pointer';
  closeBtn.style.display = 'flex';
  closeBtn.style.alignItems = 'center';
  closeBtn.style.justifyContent = 'center';
  closeBtn.style.boxShadow = '0 2px 8px rgba(44,62,80,0.10)';
  closeBtn.addEventListener('click', function() { modal.remove(); });
  header.appendChild(closeBtn);

    content.appendChild(header);

    // Subheader
    var subheader = document.createElement('div');
    subheader.textContent = 'EVENT PERFORMANCE DASHBOARD';
    subheader.style.background = '#f4f7fa';
    subheader.style.color = '#1a2233';
    subheader.style.fontWeight = '600';
    subheader.style.fontSize = '1.18em';
    subheader.style.letterSpacing = '0.7px';
    subheader.style.margin = '0 20px';
    subheader.style.marginTop = '8px';
    subheader.style.marginBottom = '12px';
    subheader.style.padding = '8px 12px';
    subheader.style.borderRadius = '10px';
    subheader.style.border = '1.5px solid #d3dbe3';
    content.appendChild(subheader);

    // Stats Row
    var statsRow = document.createElement('div');
    statsRow.style.display = 'flex';
    statsRow.style.gap = '12px';
    statsRow.style.margin = '0 20px 0 20px';
    statsRow.style.marginBottom = '12px';
    function statCard(big, label, color) {
      var card = document.createElement('div');
      card.style.flex = '1';
      card.style.background = '#f7f9fb';
      card.style.borderRadius = '10px';
      card.style.boxShadow = '0 1px 4px rgba(44,62,80,0.03)';
      card.style.display = 'flex';
      card.style.flexDirection = 'column';
      card.style.alignItems = 'center';
      card.style.justifyContent = 'center';
      card.style.padding = '10px 0 6px 0';
      card.style.minWidth = '90px';
      card.style.fontFamily = 'Segoe UI, Arial, sans-serif';
      card.style.border = '1.5px solid #d3dbe3';
      card.style.margin = '0 2px';
      var bigEl = document.createElement('div');
      bigEl.textContent = big;
      bigEl.style.fontSize = '1.6em';
      bigEl.style.fontWeight = '700';
      bigEl.style.color = color || '#1a2233';
      bigEl.style.background = '#e9eef3';
      bigEl.style.borderRadius = '6px';
      bigEl.style.padding = '7px 18px';
      bigEl.style.marginBottom = '4px';
      bigEl.style.boxShadow = '0 1px 2px rgba(44,62,80,0.03)';
      card.appendChild(bigEl);
      var labelEl = document.createElement('div');
      labelEl.textContent = label;
      labelEl.style.fontSize = '0.93em';
      labelEl.style.color = '#3a4252';
      labelEl.style.marginTop = '2px';
      labelEl.style.textAlign = 'center';
      card.appendChild(labelEl);
      return card;
    }
    // Fetch backend data for stat cards and render above the graph
    Promise.all([
      fetch('/events'),
      fetch('/logs'),
      fetch('/students')
    ]).then(async ([eventsRes, logsRes, studentsRes]) => {
      const events = await eventsRes.json();
      const logs = await logsRes.json();
      const students = await studentsRes.json();
      // Compute attendance rate per event
      let eventStats = events.map(ev => {
        let expected = 0;
        if (Array.isArray(ev.participants) && ev.participants.length > 0) {
          if (ev.participants.includes('ALL')) {
            expected = students.length;
          } else {
            expected = students.filter(s => ev.participants.includes(s["YR AND SEC"]))?.length || 0;
          }
        }
  const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut).map(l => l.fingerprintID));
        const rate = expected > 0 ? (attendees.size / expected) * 100 : 0;
        return { name: ev.name, rate, attendees: attendees.size };
      });
      // Highest and lowest attendance event by rate
      let highest = { name: '-', rate: 0 };
      let lowest = { name: '-', rate: 0 };
      if (eventStats && eventStats.length) {
        // total attendees across all events
        const totalAttendees = eventStats.reduce((acc, es) => acc + (es.attendees || 0), 0);
        // If there are no attendee logs at all, show 'No logs yet'
        if (totalAttendees === 0) {
          highest = { name: 'No logs yet', rate: 0 };
          lowest = { name: 'No logs yet', rate: 0 };
        } else {
          const sorted = eventStats.slice().sort((a, b) => b.rate - a.rate);
          highest = sorted[0] || highest;
          lowest = sorted[sorted.length - 1] || lowest;
        }
      }
      // Successful log-ins: logs with timeIn
  let successful = logs.filter(l => l.timeIn && l.timeOut).length;
      // Failed log-ins: logs with error property or fallback to 0
      let failed = logs.filter(l => l.error || l.status === 'error').length;
      if (failed === 0 && logs.length && !('error' in logs[0]) && !('status' in logs[0])) failed = 0;
  statsRow.appendChild(statCard(highest.name, 'Highest Attendance Event', '#16a085'));
  statsRow.appendChild(statCard(lowest.name, 'Lowest Attendance Event', '#16a085'));
  statsRow.appendChild(statCard(successful, 'Successful Log-Ins', '#16a085'));
  statsRow.appendChild(statCard(failed, 'Failed Log In Attempts', '#16a085'));
    });
    content.appendChild(statsRow);

    
    // Main Content Row
    var mainRow = document.createElement('div');
    mainRow.style.display = 'flex';
  mainRow.style.gap = '10px';
  mainRow.style.margin = '0 20px';
    mainRow.style.flex = '1';

    // Graph Card
    var graphCard = document.createElement('div');
    graphCard.style.background = '#fff';
    graphCard.style.background = '#f9fafb';
    graphCard.style.borderRadius = '12px';
    graphCard.style.border = '1.5px solid #e3e8ee';
    graphCard.style.boxShadow = 'none';
    graphCard.style.padding = '18px 16px 12px 16px';
    graphCard.style.flex = '2.7';
    graphCard.style.display = 'flex';
    graphCard.style.flexDirection = 'column';
    graphCard.style.alignItems = 'center';
    graphCard.style.justifyContent = 'flex-start';
    graphCard.style.minWidth = '0';
    graphCard.style.height = '100%';

    var graphTitle = document.createElement('div');
    graphTitle.textContent = 'ATTENDANCE LEVEL PER EVENT (Line Graph)';
    graphTitle.style.fontWeight = '800';
  graphTitle.style.fontSize = '1.1em';
    graphTitle.style.letterSpacing = '1px';
    graphTitle.style.color = '#222';
    graphTitle.style.marginBottom = '8px';
    graphCard.appendChild(graphTitle);

    var graphCanvas = document.createElement('canvas');
    graphCanvas.id = 'performanceModalChart';
  graphCanvas.width = 520;
  graphCanvas.height = 260;
  graphCanvas.style.maxWidth = '100%';
  graphCanvas.style.maxHeight = '100%';
  graphCanvas.style.background = '#fff';
  graphCanvas.style.borderRadius = '8px';
  graphCanvas.style.border = '1px solid #e3e8ee';
  graphCanvas.style.boxShadow = 'none';
    graphCard.appendChild(graphCanvas);

    mainRow.appendChild(graphCard);

    // Quick Stats Card (make boxes stretch to match graph height)
    var quickStats = document.createElement('div');
    quickStats.style.display = 'flex';
    quickStats.style.flexDirection = 'column';
    quickStats.style.gap = '10px';
    quickStats.style.flex = '1';
    quickStats.style.height = '100%';
    quickStats.style.alignItems = 'stretch';
    quickStats.style.justifyContent = 'space-between';

    function quickStat(label, value, highlight) {
  var box = document.createElement('div');
  box.style.background = '#e3f0ff'; // light blue
  box.style.borderRadius = '10px';
  box.style.padding = '14px 12px';
  box.style.fontFamily = 'Segoe UI, Arial, sans-serif';
  box.style.fontWeight = '500';
  box.style.fontSize = '1em';
  box.style.color = '#1a2233';
  box.style.boxShadow = '0 1px 4px rgba(44,62,80,0.03)';
  box.style.display = 'flex';
  box.style.flexDirection = 'column';
  box.style.alignItems = 'flex-start';
  box.style.justifyContent = 'center';
  box.style.border = '1.5px solid #b3d6f7';
  box.style.minWidth = '220px';
  box.style.maxWidth = '300px';
  box.style.flex = '1';
  var labelEl = document.createElement('div');
  labelEl.textContent = label;
  labelEl.style.fontWeight = '600';
  labelEl.style.fontSize = '0.93em';
  labelEl.style.color = '#3a4252';
  box.appendChild(labelEl);
  var valueEl = document.createElement('div');
  valueEl.textContent = value;
  valueEl.style.fontWeight = '700';
  valueEl.style.fontSize = '1.45em';
  valueEl.style.color = highlight || '#1a2233';
  valueEl.style.marginTop = '4px';
  box.appendChild(valueEl);
  return box;
    }
    // Fetch backend data for quick stats
    Promise.all([
      fetch('/events'),
      fetch('/logs'),
      fetch('/students')
    ]).then(async ([eventsRes, logsRes, studentsRes]) => {
      const events = await eventsRes.json();
      const logs = await logsRes.json();
      const students = await studentsRes.json();
      // Average Late Check-ins (minutes)
      // Count latecomers (diffMin > 5)
      let lateCount = 0;
      logs.forEach(l => {
        if (!l.timeIn) return;
        const ev = events.find(e => e.name === l.event_id);
        if (!ev || !ev.timeStart || !ev.date) return;
        const sched = new Date(`${ev.date}T${ev.timeStart}`);
        const timeIn = new Date(l.timeIn);
        const diffMin = (timeIn - sched) / 60000;
        if (diffMin > 5) lateCount++;
      });
      // Total expected participants (sum for all events)
      let totalExpected = 0;
      events.forEach(ev => {
        if (Array.isArray(ev.participants) && ev.participants.length > 0) {
          if (ev.participants.includes('ALL')) {
            totalExpected += students.length;
          } else {
            totalExpected += students.filter(s => ev.participants.includes(s["YR AND SEC"]))?.length || 0;
          }
        }
      });
      let latePct = null;
      if (totalExpected > 0) {
        latePct = (lateCount / totalExpected) * 100;
      }
      // No Show Rate (absenteeism): 100% - average attendance rate
      let sumRates = 0, countedEvents = 0;
      events.forEach(ev => {
        let expected = 0;
        if (Array.isArray(ev.participants) && ev.participants.length > 0) {
          if (ev.participants.includes('ALL')) {
            expected = students.length;
          } else {
            expected = students.filter(s => ev.participants.includes(s["YR AND SEC"]))?.length || 0;
          }
        }
  const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut).map(l => l.fingerprintID));
        const rate = expected > 0 ? (attendees.size / expected) * 100 : 0;
        if (expected > 0) {
          sumRates += rate;
          countedEvents++;
        }
      });
      let avgAttendance = countedEvents > 0 ? (sumRates / countedEvents) : 0;
      let noShowRate = 100 - avgAttendance;
      // Average Log-In Time (processing time from microcontroller, if available)
      let procTimes = logs.map(l => l.processingTimeMs).filter(x => typeof x === 'number' && !isNaN(x));
      let avgProc = procTimes.length ? (procTimes.reduce((a, b) => a + b, 0) / procTimes.length) : null;
      // Render quick stats
  quickStats.appendChild(quickStat('Late Check-ins (%)', latePct !== null ? latePct.toFixed(1) + '%' : '-'));
  quickStats.appendChild(quickStat('No-show Rate (%)', noShowRate.toFixed(1), '#16a085'));
  quickStats.appendChild(quickStat('Average Log In Time (ms)', avgProc !== null ? avgProc.toFixed(1) : '-', '#16a085'));
    });
    mainRow.appendChild(quickStats);

    content.appendChild(mainRow);

    // Render Chart.js graph in modal
    // Connect graph to backend
    setTimeout(function() {
      var ctx = document.getElementById('performanceModalChart').getContext('2d');
      Promise.all([
        fetch('/events'),
        fetch('/logs'),
        fetch('/students')
      ]).then(async ([eventsRes, logsRes, studentsRes]) => {
        const events = await eventsRes.json();
        const logs = await logsRes.json();
        const students = await studentsRes.json();
        const labels = events.map(ev => ev.name);
        const data = events.map(ev => {
          let expected = 0;
          if (Array.isArray(ev.participants) && ev.participants.length > 0) {
            if (ev.participants.includes('ALL')) {
              expected = students.length;
            } else {
              expected = students.filter(s => ev.participants.includes(s["YR AND SEC"]))?.length || 0;
            }
          }
  const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut).map(l => l.fingerprintID));
          return expected > 0 ? (attendees.size / expected) * 100 : 0;
        });
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: '',
              data: data,
              fill: true,
              backgroundColor: 'rgba(22,160,133,0.13)',
              borderColor: '#16a085',
              borderWidth: 3,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#16a085',
              pointRadius: 4,
              pointHoverRadius: 6,
              tension: 0.45
            }]
          },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: { display: false }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  color: '#111',
                  font: { size: 11, family: 'Segoe UI, Arial, sans-serif', weight: '400' },
                  padding: 4
                }
              },
              y: {
                min: 0,
                max: 100,
                grid: { color: 'rgba(120,120,120,0.10)' },
                ticks: {
                  color: '#111',
                  font: { size: 11, family: 'Segoe UI, Arial, sans-serif', weight: '400' },
                  stepSize: 20,
                  callback: function(value) { return value + '%'; },
                  padding: 2
                },
                title: {
                  display: false
                }
              }
            },
            elements: {
              line: { borderJoinStyle: 'round' },
              point: { borderWidth: 2 }
            },
            animation: false
          }
        });
      });
    }, 100);
    modal.appendChild(content);
    // Close modal on click outside
    modal.addEventListener('mousedown', function(e) {
      if (e.target === modal) modal.remove();
    });
    // Close on Escape
    document.addEventListener('keydown', function escListener(ev) {
      if (ev.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', escListener);
      }
    });
    document.body.appendChild(modal);
  });
});
</script>
    </div>
  <div class="report-summary-box" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:32px 40px;min-width:320px;max-width:600px;flex:1 1 0;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;min-height:120px;backdrop-filter: blur(2px);">
  <span class="summary-label" style="color:#111;font-size:1.05em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-top:-6px;margin-bottom:10px;line-height:1.2;font-family:Segoe UI, Arial, sans-serif;display:block">Attendance Breakdown by Section</span>
  <div style="width:100%;display:flex;align-items:center;justify-content:center;margin-bottom:6px;">
    <select id="attendanceSectionEventSelect" style="padding:6px 8px;border-radius:6px;border:1px solid #d3dbe3;background:#fff;color:#0a4b8c;min-width:260px;max-width:60%;"></select>
  </div>
  <div style="display:flex;flex-direction:row;align-items:center;justify-content:flex-start;width:100%;margin-bottom:8px;gap:12px;">
    <div style="width:320px;max-width:100%;height:180px;display:flex;align-items:center;justify-content:flex-start;margin-left:38px;">
      <canvas id="attendanceSectionDonutChart" width="300" height="170" style="display:block;"></canvas>
    </div>
    <div id="attendanceSectionLegend" style="display:flex;flex-direction:column;flex-wrap:wrap;gap:4px 0;min-width:110px;"></div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
  const eventSelect = document.getElementById('attendanceSectionEventSelect');
    const donutCanvas = document.getElementById('attendanceSectionDonutChart');
    const legendBox = document.getElementById('attendanceSectionLegend');
    let donutChartInstance = null;
    let events = [], logs = [], students = [];
    // Section color palette
  const sectionColors = ['#9c27b0','#16a085','#f48fb1','#26a69a','#ffd54f','#66bb6a','#00bcd4','#ff8a65','#607d8b','#8bc34a'];
    // Fetch all data
    Promise.all([
      fetch('/events'),
      fetch('/logs'),
      fetch('/students')
    ]).then(async ([eventsRes, logsRes, studentsRes]) => {
      events = await eventsRes.json();
      logs = await logsRes.json();
      students = await studentsRes.json();
      // Determine a sensible event to display and label it with the event's real name.
      // Strategy:
      //  1) If there are logs, prefer the event referenced by the most recent log that has timeIn
      //  2) Otherwise fall back to the newest event by date/createdAt
      //  3) As a final fallback use the last event in the array
      let chosenEventId = null;
      let chosenEventObj = null;

      // find latest log with timeIn (search from end for performance / recency)
      if (Array.isArray(logs) && logs.length) {
        for (let i = logs.length - 1; i >= 0; i--) {
          const l = logs[i];
          if (l && l.timeIn && l.event_id) {
            // try to resolve to an event object first
            chosenEventObj = events.find(ev => String(ev._id) === String(l.event_id) || ev.name === l.event_id);
            if (chosenEventObj) {
              chosenEventId = String(chosenEventObj._id || chosenEventObj.name || l.event_id);
            } else {
              // keep the id from the log if no matching event object
              chosenEventId = String(l.event_id);
            }
            break;
          }
        }
      }

      // If still not chosen, pick the most recent event by date/createdAt
      if (!chosenEventId && Array.isArray(events) && events.length) {
        const eventsWithDates = events.slice().filter(e => e && (e.date || e.createdAt)).sort((a,b)=> {
          const da = Date.parse(a.date || a.createdAt || 0);
          const db = Date.parse(b.date || b.createdAt || 0);
          return db - da;
        });
        const latest = eventsWithDates.length ? eventsWithDates[0] : events[events.length - 1];
        chosenEventObj = latest;
        chosenEventId = String(latest._id || latest.name || '');
      }

      // As a final fallback, if we still have nothing, try the last event element
      if (!chosenEventId && Array.isArray(events) && events.length) {
        const last = events[events.length - 1];
        chosenEventObj = last;
        chosenEventId = String(last._id || last.name || '');
      }

      // Populate event select (include All option) and set default selection
      if (eventSelect) {
        let opts = '<option value="ALL">All Events</option>';
        events.forEach(ev => { opts += `<option value="${ev._id}">${ev.name}</option>`; });
        eventSelect.innerHTML = opts;
        // Try to select the chosenEventId if resolved; otherwise select latest event or ALL
        if (chosenEventId && Array.from(eventSelect.options).some(o => o.value === String(chosenEventId))) {
          eventSelect.value = String(chosenEventId);
        } else if (events.length) {
          // default to most recent event
          const latest = events[events.length - 1];
          eventSelect.value = String(latest._id || 'ALL');
        } else {
          eventSelect.value = 'ALL';
        }
        // Render initial selection
        renderDonut(eventSelect.value);
        // Wire change
        eventSelect.addEventListener('change', function() { renderDonut(this.value); });
      } else {
        if (chosenEventId) renderDonut(chosenEventId);
      }
    });
    // If an event select exists (removed in UI), wire it; otherwise ignore
    if (typeof eventSelect !== 'undefined' && eventSelect && eventSelect.addEventListener) {
      eventSelect.addEventListener('change', function() {
        renderDonut(eventSelect.value);
      });
    }

    function renderDonut(eventId) {
      // Find all sections
      const allSections = Array.from(new Set(students.map(s => s["YR AND SEC"]).filter(Boolean)));
      // Helper to match a log to an event id/name
      const matchLogToEvent = (log, evId) => {
        if (!log) return false;
        try {
          return String(log.event_id) === String(evId) || String(log.event_name) === String(evId);
        } catch (e) { return false; }
      };

      let data = [];
      if (String(eventId) === 'ALL') {
        // Count unique attendees across all logs (each student counted once) and map to sections
        const attendedFIDs = new Set(logs.filter(l => l && l.timeIn).map(l => String(l.fingerprintID)));
        data = allSections.map(sec => {
          const inSectionFIDs = new Set(students.filter(s => s["YR AND SEC"] === sec).map(s => String(s.FID)));
          let count = 0;
          for (const fid of attendedFIDs) {
            if (inSectionFIDs.has(String(fid))) count++;
          }
          return count;
        });
      } else {
        // For selected event, count unique attendees by section (match by event_id or legacy event_name)
        data = allSections.map(sec => {
          const sectionFIDs = students.filter(s => s["YR AND SEC"] === sec).map(s => s.FID);
                  const attendees = new Set(logs.filter(l => matchLogToEvent(l, eventId) && l.timeIn && l.timeOut && sectionFIDs.includes(l.fingerprintID)).map(l => l.fingerprintID));
          return attendees.size;
        });
      }
      // Render donut chart
      if (donutChartInstance && typeof donutChartInstance.destroy === 'function') donutChartInstance.destroy();
      donutChartInstance = new Chart(donutCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: allSections,
          datasets: [{
            data: data,
            backgroundColor: sectionColors.slice(0, allSections.length),
            borderWidth: 2,
            borderColor: '#fff',
            hoverOffset: 8
          }]
        },
        options: {
          cutout: '70%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          animation: false
        }
      });
      // Render legend
      legendBox.innerHTML = '';
      allSections.forEach((sec, i) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '5px';
        row.style.marginBottom = '2px';
        const colorBox = document.createElement('span');
        colorBox.style.width = '13px';
        colorBox.style.height = '13px';
        colorBox.style.display = 'inline-block';
        colorBox.style.background = sectionColors[i % sectionColors.length];
        colorBox.style.borderRadius = '3px';
        row.appendChild(colorBox);
        const label = document.createElement('span');
        label.textContent = sec;
        label.style.color = '#0a4b8c';
        label.style.fontSize = '0.95em';
        label.style.fontWeight = '600';
        label.style.fontFamily = 'Segoe UI, Arial, sans-serif';
        row.appendChild(label);
        legendBox.appendChild(row);
      });
    }
  });
  </script>
  <!-- Open Performance Window 2 removed -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var btn2 = document.getElementById('openPerformanceWindowBtn2');
      if (btn2) {
        btn2.addEventListener('click', function() {
          let performanceDonutChartInstance = null;
          var old = document.getElementById('performanceWindowModal');
          if (old) old.remove();
          var sidebar = document.querySelector('.sidebar');
          var sidebarWidth = sidebar ? sidebar.offsetWidth : 210;
          var modal = document.createElement('div');
          modal.id = 'performanceWindowModal';
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = sidebarWidth + 'px';
          modal.style.width = 'calc(100vw - ' + sidebarWidth + 'px)';
          modal.style.height = '100vh';
          modal.style.background = 'rgba(0,0,0,0.18)';
          modal.style.display = 'flex';
          modal.style.alignItems = 'center';
          modal.style.justifyContent = 'center';
          modal.style.zIndex = '99999';

          
          var content = document.createElement('div');
          content.style.background = '#fff';
          content.style.borderRadius = '32px';
          content.style.boxShadow = '0 12px 40px rgba(44,62,80,0.20)';
          content.style.minWidth = '600px';
          content.style.minHeight = '520px';
          content.style.maxWidth = '92vw';
          content.style.maxHeight = '98vh';
          content.style.width = 'clamp(600px, 75vw, 950px)';
          content.style.height = 'clamp(520px, 90vh, 700px)';
          content.style.display = 'flex';
          content.style.flexDirection = 'column';
          content.style.position = 'relative';
          content.style.padding = '0';
          content.style.overflow = 'hidden';

          // Header
          var header = document.createElement('div');
          header.style.background = 'linear-gradient(90deg,#e3f0ff 80%,#d0e7ff 100%)';
          header.style.borderTopLeftRadius = '28px';
          header.style.borderTopRightRadius = '28px';
          header.style.padding = '4px 10px 2px 16px';
          header.style.position = 'relative';
          header.style.display = 'flex';
          header.style.alignItems = 'center';
          header.style.justifyContent = 'space-between';
          var title = document.createElement('div');
          title.textContent = 'REPORTS';
          title.style.fontSize = '1.18em';
          title.style.fontWeight = '600';
          title.style.letterSpacing = '0.7px';
          title.style.color = '#1a2233';
          title.style.fontFamily = 'Segoe UI, Arial, sans-serif';
          header.appendChild(title);
          var closeBtn = document.createElement('button');
          closeBtn.innerHTML = '&times;';
          closeBtn.style.position = 'absolute';
          closeBtn.style.top = '2px';
          closeBtn.style.right = '6px';
          closeBtn.style.width = '24px';
          closeBtn.style.height = '24px';
          closeBtn.style.background = '#f44336';
          closeBtn.style.color = '#fff';
          closeBtn.style.border = 'none';
          closeBtn.style.borderRadius = '50%';
          closeBtn.style.fontSize = '1em';
          closeBtn.style.cursor = 'pointer';
          closeBtn.style.display = 'flex';
          closeBtn.style.alignItems = 'center';
          closeBtn.style.justifyContent = 'center';
          closeBtn.style.boxShadow = '0 2px 8px rgba(44,62,80,0.10)';
          closeBtn.addEventListener('click', function() { modal.remove(); });
          header.appendChild(closeBtn);
          content.appendChild(header);

          // Subheader
          var subheader = document.createElement('div');
          subheader.textContent = 'EVENT PERFORMANCE DASHBOARD';
          subheader.style.background = '#f4f7fa';
          subheader.style.color = '#1a2233';
          subheader.style.fontWeight = '600';
          subheader.style.fontSize = '1.18em';
          subheader.style.letterSpacing = '0.7px';
          subheader.style.margin = '0 20px';
          subheader.style.marginTop = '8px';
          subheader.style.marginBottom = '12px';
          subheader.style.padding = '8px 12px';
          subheader.style.borderRadius = '10px';
          subheader.style.border = '1.5px solid #d3dbe3';
          content.appendChild(subheader);

          // Stats Row
          var statsRow = document.createElement('div');
          statsRow.style.display = 'flex';
          statsRow.style.gap = '12px';
          statsRow.style.margin = '0 20px 0 20px';
          statsRow.style.marginBottom = '12px';
          function statCard(big, label, color) {
            var card = document.createElement('div');
            card.style.flex = '1';
            card.style.background = '#f7f9fb';
            card.style.borderRadius = '10px';
            card.style.boxShadow = '0 1px 4px rgba(44,62,80,0.03)';
            card.style.display = 'flex';
            card.style.flexDirection = 'column';
            card.style.alignItems = 'center';
            card.style.justifyContent = 'center';
            card.style.padding = '10px 0 6px 0';
            card.style.minWidth = '90px';
            card.style.fontFamily = 'Segoe UI, Arial, sans-serif';
            card.style.border = '1.5px solid #d3dbe3';
            card.style.margin = '0 2px';
            var bigEl = document.createElement('div');
            bigEl.textContent = big;
            bigEl.style.fontSize = '1.6em';
            bigEl.style.fontWeight = '700';
            bigEl.style.color = color || '#1a2233';
            bigEl.style.background = '#e9eef3';
            bigEl.style.borderRadius = '6px';
            bigEl.style.padding = '7px 18px';
            bigEl.style.marginBottom = '4px';
            bigEl.style.boxShadow = '0 1px 2px rgba(44,62,80,0.03)';
            card.appendChild(bigEl);
            var labelEl = document.createElement('div');
            labelEl.textContent = label;
            labelEl.style.fontSize = '0.93em';
            labelEl.style.color = '#3a4252';
            labelEl.style.marginTop = '2px';
            labelEl.style.textAlign = 'center';
            card.appendChild(labelEl);
            return card;
          }
          // Fetch backend data for section stats
          Promise.all([
            fetch('/events').then(r => r.json()),
            fetch('/logs').then(r => r.json()),
            fetch('/students').then(r => r.json())
          ]).then(([events, logs, students]) => {
            // Get all sections
            const allSections = Array.from(new Set(students.map(s => s["YR AND SEC"]))).filter(Boolean);
            // For each section, compute attendance rate (total attended / total expected)
            let sectionStats = allSections.map(sec => {
              // Students in this section
              const sectionFIDs = students.filter(s => s["YR AND SEC"] === sec).map(s => s.FID);
              // For all events, expected = students in section if event includes section
              let expected = 0, attended = 0;
              events.forEach(ev => {
                if (Array.isArray(ev.participants) && (ev.participants.includes('ALL') || ev.participants.includes(sec))) {
                  expected += sectionFIDs.length;
                  // Attended: logs for this event, this section
              const attendees = new Set(logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut && sectionFIDs.includes(l.fingerprintID)).map(l => l.fingerprintID));
                  attended += attendees.size;
                }
              });
              const rate = expected > 0 ? (attended / expected) * 100 : 0;
              // Successful log-ins: logs with timeIn for this section
              const successful = logs.filter(l => l.timeIn && l.timeOut && sectionFIDs.includes(l.fingerprintID)).length;
              // Failed log-ins: logs with error/status=error for this section
              const failed = logs.filter(l => (l.error || l.status === 'error') && sectionFIDs.includes(l.fingerprintID)).length;
              return { sec, rate, successful, failed };
            });
            // Highest and lowest attendance section
            let highest = sectionStats.length ? sectionStats.reduce((a, b) => (a.rate > b.rate ? a : b)) : { sec: '-', rate: 0 };
            let lowest = sectionStats.length ? sectionStats.reduce((a, b) => (a.rate < b.rate ? a : b)) : { sec: '-', rate: 0 };
            // Check if all rates are equal
            let allEqual = sectionStats.length > 1 && sectionStats.every(s => s.rate === sectionStats[0].rate);
            // Average successful/failed log-ins per section
            let avgSuccessful = sectionStats.length ? (sectionStats.reduce((a, b) => a + b.successful, 0) / sectionStats.length) : 0;
            let avgFailed = sectionStats.length ? (sectionStats.reduce((a, b) => a + b.failed, 0) / sectionStats.length) : 0;
            statsRow.appendChild(statCard(
              allEqual ? 'N/A' : highest.rate.toFixed(1) + '%',
              allEqual ? 'Highest % Attendance Section' : 'Highest % Attendance Section (' + highest.sec + ')',
              '#1976d2'
            ));
            statsRow.appendChild(statCard(
              allEqual ? 'N/A' : lowest.rate.toFixed(1) + '%',
              allEqual ? 'Lowest % Attendance Section' : 'Lowest % Attendance Section (' + lowest.sec + ')',
              '#1976d2'
            ));
            statsRow.appendChild(statCard(
              Math.round(avgSuccessful),
              'Average Successful Log-Ins per section',
              '#1976d2'
            ));
            statsRow.appendChild(statCard(
              Math.round(avgFailed),
              'Average Failed Log In Attempts per section',
              '#1976d2'
            ));
          });
          content.appendChild(statsRow);

          // Main Content Row
          var mainRow = document.createElement('div');
          mainRow.style.display = 'flex';
          mainRow.style.gap = '10px';
          mainRow.style.margin = '0 20px';
          mainRow.style.flex = '1';

          // Graph Card (Attendance Breakdown Donut)
          // Graph Card (Attendance Breakdown Donut) - REPLACEMENT BLOCK
    var graphCard = document.createElement('div');
    graphCard.style.cssText = `
      background: #f9fafb; border-radius: 12px; border: 1.5px solid #e3e8ee;
      padding: 12px 12px 12px 12px; flex: 2.7; display: flex;
      flex-direction: column; align-items: stretch; justify-content: flex-start;
      min-width: 0; height: 100%; overflow: hidden; box-sizing: border-box;`;

    // Wrap the canvas in a fixed-height flex wrapper so Chart.js doesn't cause
    // the modal to grow when it recalculates sizes (common with responsive charts).
    var graphWrapper = document.createElement('div');
    graphWrapper.style.cssText = `flex: 1 1 auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; min-height: 300px; box-sizing: border-box; padding: 6px;`;

    var graphCanvas = document.createElement('canvas');
    graphCanvas.id = 'performanceModalSectionDonutChart';
    // Ensure canvas fills the wrapper and uses block layout so width/height calculations
    // are stable and don't create growth loops.
    graphCanvas.style.cssText = `width: 100%; height: 100%; max-width: 100%; max-height: 100%; display: block; box-sizing: border-box;`;

    graphWrapper.appendChild(graphCanvas);
    graphCard.appendChild(graphWrapper);

    mainRow.appendChild(graphCard);
      // --- 2. FETCH DATA & RENDER CHART (with added destroy logic) ---
        // This variable will hold our chart instance so we can manage it.
        async function renderAttendanceRateBySection() {
            try {
                // *** FIX: Destroy the previous chart instance if it exists ***
                if (performanceDonutChartInstance) {
                    performanceDonutChartInstance.destroy();
                }

                const [students, events, logs] = await Promise.all([
                    fetch('/students').then(res => res.json()),
                    fetch('/events').then(res => res.json()),
                    fetch('/logs').then(res => res.json())
                ]);

                if (!students || !events) {
                    graphCard.innerHTML = "<p>Could not load student or event data.</p>";
                    return;
                }

                const sections = [...new Set(students.map(s => s['YR AND SEC']).filter(Boolean))].sort();
                const studentMap = new Map(students.map(s => [String(s.FID), s]));
                
                const sectionRates = sections.map(sec => {
                    const studentsInSection = students.filter(s => s['YR AND SEC'] === sec);
                    if (studentsInSection.length === 0) return 0;
                    
                    let totalExpected = 0;
                    let totalAttended = 0;

                    for (const event of events) {
                        const isParticipantSection = (Array.isArray(event.participants) && (event.participants.includes('ALL') || event.participants.includes(sec))) || 
                                                     (event.participants && Array.isArray(event.participants.sections) && (event.participants.sections.includes('ALL') || event.participants.sections.includes(sec)));
                        
                        if (isParticipantSection) {
                            totalExpected += studentsInSection.length;
                            
                            const attendedFIDs = new Set(logs.filter(log => 
                                (log.event_id === String(event._id) || log.event_name === event.name) &&
                                log.timeIn &&
                                studentMap.has(String(log.fingerprintID)) &&
                                studentMap.get(String(log.fingerprintID))['YR AND SEC'] === sec
                            ).map(log => log.fingerprintID));
                            
                            totalAttended += attendedFIDs.size;
                        }
                    }

                    return totalExpected > 0 ? ((totalAttended / totalExpected) * 100) : 0;
                });
                
                const ctx = graphCanvas.getContext('2d');
                // *** FIX: Assign the new chart to our variable ***
                performanceDonutChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sections,
                        datasets: [{
                            label: 'Attendance Rate',
                            data: sectionRates,
                            backgroundColor: ['#3b82f6', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#eab308', '#0ea5e9', '#ec4899'],
                            borderColor: '#fff',
                            borderWidth: 3,
                            hoverOffset: 12
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { font: { size: 14 } }
                            },
                            title: {
                                display: true,
                                text: 'Overall Attendance Rate by Section (%)',
                                font: { size: 16, weight: 'bold', family: 'Segoe UI, Arial, sans-serif' },
                                padding: { top: 0, bottom: 20 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error("Failed to render attendance rate chart:", error);
                graphCard.innerHTML = "<p style='color:red;'>Error loading chart data.</p>";
            }
        }
        
        // Render the chart after the modal is built
        setTimeout(renderAttendanceRateBySection, 100);

          // Quick Stats Card
          var quickStats = document.createElement('div');
          quickStats.style.display = 'flex';
          quickStats.style.flexDirection = 'column';
          quickStats.style.gap = '8px';
          quickStats.style.flex = '1';
          quickStats.style.height = '100%';
          function quickStat(label, value, highlight) {
            var box = document.createElement('div');
            box.style.background = '#e3f0ff';
            box.style.borderRadius = '10px';
            box.style.padding = '10px 12px';
            box.style.fontFamily = 'Segoe UI, Arial, sans-serif';
            box.style.fontWeight = '500';
            box.style.fontSize = '1em';
            box.style.color = '#1a2233';
            box.style.boxShadow = '0 1px 4px rgba(44,62,80,0.03)';
            box.style.display = 'flex';
            box.style.flexDirection = 'column';
            box.style.alignItems = 'flex-start';
            box.style.border = '1.5px solid #b3d6f7';
            var labelEl = document.createElement('div');
            labelEl.textContent = label;
            labelEl.style.fontWeight = '600';
            labelEl.style.fontSize = '0.93em';
            labelEl.style.color = '#3a4252';
            box.appendChild(labelEl);
            var valueEl = document.createElement('div');
            valueEl.textContent = value;
            valueEl.style.fontWeight = '700';
            // Reduce font size for Quick Stat A only
            if (label.startsWith('Quick Stat A')) {
              valueEl.style.fontSize = '1.08em';
            } else {
              valueEl.style.fontSize = '1.45em';
            }
            valueEl.style.color = highlight || '#1a2233';
            valueEl.style.marginTop = '2px';
            box.appendChild(valueEl);
            return box;
          }
          // Fetch backend data for quick stats
          Promise.all([
            fetch('/events').then(r => r.json()),
            fetch('/logs').then(r => r.json()),
            fetch('/students').then(r => r.json())
          ]).then(([events, logs, students]) => {
            // Top 3 Sections by % Attendance
            const allSections = Array.from(new Set(students.map(s => s["YR AND SEC"]))).filter(Boolean);
            let sectionStats = allSections.map(sec => {
              const sectionFIDs = students.filter(s => s["YR AND SEC"] === sec).map(s => s.FID);
              let expected = 0, attended = 0, lateCount = 0;
              events.forEach(ev => {
                if (Array.isArray(ev.participants) && (ev.participants.includes('ALL') || ev.participants.includes(sec))) {
                  expected += sectionFIDs.length;
                  // Attended: logs for this event, this section
                  const attendees = logs.filter(l => String(l.event_id) === String(ev._id) && l.timeIn && l.timeOut && sectionFIDs.includes(l.fingerprintID));
                  attended += new Set(attendees.map(l => l.fingerprintID)).size;
                  // Late log-ins: timeIn within 30min after event start
                  attendees.forEach(l => {
                    const evObj = events.find(e => e.name === l.event_id);
                    if (evObj && evObj.timeStart && evObj.date) {
                      const sched = new Date(`${evObj.date}T${evObj.timeStart}`);
                      const timeIn = new Date(l.timeIn);
                      const diffMin = (timeIn - sched) / 60000;
                      if (diffMin > 0 && diffMin <= 30) lateCount++;
                    }
                  });
                }
              });
              const rate = expected > 0 ? (attended / expected) * 100 : 0;
              return { sec, rate, lateCount, expected };
            });
            // Top 3 sections by attendance rate
            const sortedSections = sectionStats.slice().sort((a, b) => b.rate - a.rate);
            // Check if all rates are equal
            let allEqual = sectionStats.length > 1 && sectionStats.every(s => s.rate === sectionStats[0].rate);
            let topSections = allEqual ? 'N/A' : sortedSections.slice(0, 3).map(s => s.sec).join(', ');
            // Average late log-ins per section
            let avgLate = sectionStats.length ? (sectionStats.reduce((a, b) => a + b.lateCount, 0) / sectionStats.length) : 0;
            // Attendance Consistency Score: stddev of section rates (lower is more consistent)
            let mean = sectionStats.length ? (sectionStats.reduce((a, b) => a + b.rate, 0) / sectionStats.length) : 0;
            let variance = sectionStats.length ? (sectionStats.reduce((a, b) => a + Math.pow(b.rate - mean, 2), 0) / sectionStats.length) : 0;
            let consistencyScore = sectionStats.length ? (100 - Math.sqrt(variance)) : 0;
            quickStats.appendChild(quickStat('Quick Stat A: Top 3 Sections by % Attendance', topSections || '-', '#16a085'));
            quickStats.appendChild(quickStat('Quick Stat B: Average Late Log-ins per Section', avgLate.toFixed(2), '#16a085'));
            quickStats.appendChild(quickStat('Quick Stat C: Attendance Consistency Score', consistencyScore.toFixed(1) + '%', '#16a085'));
          });
          mainRow.appendChild(quickStats);
          content.appendChild(mainRow);
          modal.appendChild(content);
          // Close modal on click outside
          modal.addEventListener('mousedown', function(e) {
            if (e.target === modal) modal.remove();
          });
          // Close on Escape
          document.addEventListener('keydown', function escListener(ev) {
            if (ev.key === 'Escape') {
              modal.remove();
              document.removeEventListener('keydown', escListener);
            }
          });
          document.body.appendChild(modal);
        });
      }
    });
  </script>
    </div>
  </div>
<!-- New full-width report section at the bottom of Reports sidebar -->
<div class="report-summary-box" style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:32px 40px;min-width:320px;max-width:890px;width:100%;display:flex;flex-direction:column;align-items:stretch;justify-content:center;position:relative;min-height:120px;backdrop-filter: blur(2px);margin:16px auto 0 auto;box-sizing:border-box;">
  <div style="width:100%;margin-bottom:6px;box-sizing:border-box;">
    <h2 style="color:#111;font-size:1.25em;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;border-bottom:1px solid #e3eafc;padding-bottom:2px;">Upcoming Event Readiness</h2>
  </div>
  <div id="upcomingEventReadinessCards" style="width:100%;display:flex;flex-direction:column;gap:12px;box-sizing:border-box;"></div>
  <script>
  // Dynamically render upcoming events with no attendance sheet, 2 cards per row, soonest event first
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('upcomingEventReadinessCards');
    if (!container) return;
    Promise.all([
      fetch('/events').then(r => r.json()),
      fetch('/logs').then(r => r.json())
    ]).then(([events, logs]) => {
      // Find events with no attendance records (no logs for that event)
      // Build a set that includes both event_id values and event_name values found in logs
      const eventsWithLogs = new Set();
      logs.forEach(l => {
        if (l.event_id) eventsWithLogs.add(String(l.event_id));
        if (l.event_name) eventsWithLogs.add(String(l.event_name));
      });
      // An event is considered to have logs if its _id or its name appears in the logs set
      let upcoming = events.filter(ev => {
        const idStr = ev._id ? String(ev._id) : '';
        const nameStr = ev.name ? String(ev.name) : '';
        return !eventsWithLogs.has(idStr) && !eventsWithLogs.has(nameStr);
      });
      // Sort by soonest date (ascending)
      upcoming.sort((a, b) => {
        // Try to parse date as YYYY-MM-DD or similar
        const da = Date.parse(a.date);
        const db = Date.parse(b.date);
        if (!isNaN(da) && !isNaN(db)) return da - db;
        if (!isNaN(da)) return -1;
        if (!isNaN(db)) return 1;
        return 0;
      });
      container.innerHTML = '';
      if (upcoming.length === 0) {
        container.innerHTML = '<div style="padding:18px 0;color:#1976d2;font-weight:600;font-size:1.08em;text-align:center;">All events have attendance sheets.</div>';
        return;
      }
      // Group events into rows of 2, with soonest event first
      for (let i = 0; i < upcoming.length; i += 2) {
  const rowDiv = document.createElement('div');
  rowDiv.style.display = 'flex';
  rowDiv.style.flexDirection = 'row';
  rowDiv.style.alignItems = 'stretch';
  rowDiv.style.gap = '18px';
  rowDiv.style.marginBottom = '0';
  rowDiv.style.width = '100%';
  rowDiv.style.boxSizing = 'border-box';
        // Add up to 2 cards per row
        for (let j = i; j < i + 2 && j < upcoming.length; j++) {
          const ev = upcoming[j];
          const card = document.createElement('div');
          card.style.background = 'rgba(173,216,230,0.35)';
          card.style.border = '1px solid #111';
          card.style.borderRadius = '14px';
          card.style.padding = '14px 18px';
          card.style.boxShadow = '0 1px 4px rgba(44,62,80,0.05)';
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.gap = '6px';
          card.style.flex = '1';
          card.style.minWidth = '0';
          card.style.boxSizing = 'border-box';
          // Title row
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '7px';
          const icon = document.createElement('span');
          icon.innerHTML = '&#128197;';
          icon.style.fontSize = '1.15em';
          icon.style.color = '#16a085';
          row.appendChild(icon);
          const title = document.createElement('span');
          title.textContent = ev.name;
          title.style.fontSize = '1.08em';
          title.style.fontWeight = '700';
          title.style.color = '#111';
          row.appendChild(title);
          card.appendChild(row);
          // Date row
          const dateRow = document.createElement('div');
          dateRow.style.marginLeft = '4px';
          dateRow.style.marginTop = '4px';
          dateRow.style.fontSize = '0.98em';
          dateRow.style.fontWeight = '600';
          dateRow.style.color = '#222';
          dateRow.innerHTML = `<span style="border-left:3px solid #b3e6d6;padding-left:6px;">Target Date: <span style="color:#16a085;font-weight:600;">${ev.date ? ev.date : '-'}</span></span>`;
          card.appendChild(dateRow);
          rowDiv.appendChild(card);
        }
        container.appendChild(rowDiv);
      }
    });
  });
  </script>
</div>
  </section>
  <section id="studentAnalyticsSection" class="card" style="display:none;background:rgba(255,255,255,0.65);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 48px;margin-bottom:18px;">
  <div class="student-analytics-card" style="display:flex;flex-direction:column;">
    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;margin-top:2px;">
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:8px;">
          <div style="margin-bottom:2px;width:100%;display:flex;align-items:center;">
            <label for="studentAnalyticsFilter" style="font-weight:600;font-size:0.95em;color:#222;margin-right:8px;">Type Student Name:</label>
            <input type="text" id="studentAnalyticsFilter" placeholder="e.g. Juan Dela Cruz" style="padding:5px 10px;border-radius:8px;border:1px solid #ccc;font-size:0.95em;width:200px;">
          </div>
          <div style="display:flex;align-items:center;gap:14px;">
            <div style="background:#f7f7fa;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;">
              <span style="font-size:28px;">&#128104;&#8205;&#128187;</span>
            </div>
            <div id="studentAnalyticsDetailsBox">
              <div style="font-size:1.2em;font-weight:700;color:#222;">Type a student name above</div>
            </div>
<script>
// Student Analytics: Search by Student Number and display details
document.addEventListener('DOMContentLoaded', function() {
  var studentInput = document.getElementById('studentAnalyticsFilter');
  var detailsBox = document.getElementById('studentAnalyticsDetailsBox');
  if (!studentInput || !detailsBox) return;
  let studentsCache = [];
  async function fetchStudents() {
    if (studentsCache.length) return studentsCache;
    const res = await fetch('/students');
    if (!res.ok) return [];
    studentsCache = await res.json();
    return studentsCache;
  }
  // Helper: determine if an event includes this student either by section, by explicit student number, or by ALL
  window.isEventForStudent = function(ev, student) {
    if (!ev || !student) return false;
    const studentNo = String(student['STUDENT NO'] || '').toLowerCase();
    const yrsec = String(student['YR AND SEC'] || '');
    const parts = ev.participants;
    if (Array.isArray(parts)) {
      // parts may contain 'ALL', section names, or student numbers
      if (parts.includes('ALL')) return true;
      if (yrsec && parts.includes(yrsec)) return true;
      // check if any participant equals student's STUDENT NO (case-insensitive)
      for (let p of parts) {
        if (String(p).toLowerCase() === studentNo) return true;
      }
      return false;
    } else if (parts && typeof parts === 'object') {
      const secs = Array.isArray(parts.sections) ? parts.sections : [];
      const studs = Array.isArray(parts.students) ? parts.students : [];
      if (secs.includes('ALL')) return true;
      if (yrsec && secs.includes(yrsec)) return true;
      for (let s of studs) {
        if (String(s).toLowerCase() === studentNo) return true;
      }
      return false;
    }
    return false;
  };
  function showStudent(student) {
    detailsBox.innerHTML = `
      <div style="font-size:1.2em;font-weight:700;color:#222;">${student.NAME}</div>
      <div style="font-size:0.95em;color:#555;margin-top:2px;">
        <span style="font-weight:600;color:#222;">${student.FID}</span> |
        <span style="color:#222;">${student["STUDENT NO"]}</span> |
        <span style="color:#222;">${student["YR AND SEC"]}</span> |
        <span style="color:#222;">${student.SEX}</span> |
        <span style="color:#222;">${student.EMAIL}</span>
      </div>
    `;
    // Calculate attendance stats for this student
    Promise.all([
      fetch('/events').then(r => r.json()),
      fetch('/logs').then(r => r.json())
    ]).then(([events, logs]) => {
  // Only consider events where student's YR AND SEC is a participant or 'ALL' is a participant
  const relevantEvents = events.filter(ev => window.isEventForStudent(ev, student));
      const totalEvents = relevantEvents.length;
      // Find attended events among relevant events (match by event _id)
      const relevantEventIds = new Set(relevantEvents.map(ev => String(ev._id)));
      const attendedEventIds = new Set(
        logs
          .filter(l => String(l.fingerprintID) === String(student.FID) && l.timeIn && l.timeOut && relevantEventIds.has(String(l.event_id)))
          .map(l => String(l.event_id))
      );
      const attendedCount = attendedEventIds.size;
      const absentCount = totalEvents - attendedCount;
      let rate = 0;
      if (totalEvents > 0) {
        rate = Math.round((attendedCount / totalEvents) * 100);
      }
      // Update attendance rate
      const rateSpan = document.querySelector('span[attendance-rate-value]');
      if (rateSpan) {
        rateSpan.textContent = rate + '%';
      }
      // Update events present
      const presentSpan = document.querySelector('span[events-present-value]');
      if (presentSpan) {
        presentSpan.textContent = attendedCount;
      }
      // Update events absent
      const absentSpan = document.querySelector('span[events-absent-value]');
      if (absentSpan) {
        absentSpan.textContent = absentCount;
      }
      // Update attendance trend chart (pass only relevant events)
      renderAttendanceTrendChart(student, relevantEvents);
      // Update punctuality history chart (pass only relevant events)
      renderPunctualityHistoryChart(student, relevantEvents);
      // Start an auto-refresh for these charts so new logs show up automatically while this student is open
      startStudentAnalyticsAutoRefresh(student, relevantEvents);
    });
  }
  function showNoStudent() {
    detailsBox.innerHTML = '<span style="color:#f44336;font-weight:600;">No student found.</span>';
    stopStudentAnalyticsAutoRefresh();
  }
  function showDefaultStudent() {
    if (studentsCache.length) {
      showStudent(studentsCache[0]);
    } else {
      detailsBox.innerHTML = '<div style="font-size:1.2em;font-weight:700;color:#222;">Type a student name above</div>';
    }
    // Ensure auto-refresh is stopped when default/no specific student is shown
    if (!studentsCache.length) stopStudentAnalyticsAutoRefresh();
  }
  studentInput.addEventListener('input', async function() {
    const val = studentInput.value.trim();
    const students = await fetchStudents();
    if (!val) {
      showDefaultStudent();
      return;
    }
  const q = val.toLowerCase();
  // Match by name (case-insensitive substring). NAME may be stored as 'Last, First' or other variants.
  const student = students.find(s => (String(s.NAME || '')).toLowerCase().includes(q));
    if (student) {
      showStudent(student);
    } else {
      showNoStudent();
    }
  });
  // Show default student on load
  fetchStudents().then(showDefaultStudent);
});
</script>
          </div>
        </div>
        <div style="display:flex;flex-direction:row;gap:12px;align-items:flex-start;">
          <div style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:14px 12px;min-width:110px;max-width:140px;min-height:110px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter: blur(2px);flex:1;align-self:stretch;border:1px solid #16a085;">
            <span style="color:#000;font-size:0.92em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Attendance Rate</span>
            <span attendance-rate-value style="font-size:1.9em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">60%</span>
            <span style="font-size:0.95em;color:#000;margin-top:2px;opacity:0.95;text-align:center;">of this student</span>
          </div>
          <div style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:14px 12px;min-width:110px;max-width:140px;min-height:110px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter: blur(2px);flex:1;align-self:stretch;border:1px solid #16a085;">
            <span style="color:#000;font-size:0.92em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Events Present</span>
            <span events-present-value style="font-size:1.9em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">12</span>
            <span style="font-size:0.95em;color:#000;margin-top:2px;opacity:0.95;text-align:center;">attended</span>
          </div>
          <div style="background:rgba(255,255,255,0.18);box-shadow:0 2px 12px rgba(44,62,80,0.13);border-radius:18px;padding:14px 12px;min-width:110px;max-width:140px;min-height:110px;height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;backdrop-filter: blur(2px);flex:1;align-self:stretch;border:1px solid #16a085;">
            <span style="color:#000;font-size:0.92em;font-weight:600;letter-spacing:1px;text-transform:uppercase;text-align:center;margin-bottom:2px;">Events Absent</span>
            <span events-absent-value style="font-size:1.9em;font-weight:700;color:#16a085;line-height:1.1;margin-bottom:0;">8</span>
            <span style="font-size:0.95em;color:#000;margin-top:2px;opacity:0.95;text-align:center;">missed</span>
          </div>
        </div>
      </div>
    </div>

  <div style="display:flex;flex-direction:row;gap:24px;width:100%;max-width:1400px;margin-top:18px;margin-bottom:18px;">
  <div class="student-analytics-card" style="flex:1;display:flex;flex-direction:column;background:rgba(255,255,255,0.18);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 32px;align-items:flex-start;min-width:220px;max-width:100%;border:1px solid #16a085;">
    <div style="flex:1;display:flex;align-items:center;justify-content:flex-start;min-height:295px;width:100%;">
  <canvas id="monthlyAttendanceTrendChart" style="width:100%;max-width:420px;height:320px;"></canvas>
      </div>
    </div>
  <div class="student-analytics-card" style="flex:1;display:flex;flex-direction:column;background:rgba(255,255,255,0.18);border-radius:20px;box-shadow:0 2px 16px rgba(44,62,80,0.08);padding:24px 32px;align-items:flex-start;min-width:220px;max-width:100%;border:1px solid #16a085;">
    <div style="flex:1;display:flex;align-items:center;justify-content:center;min-height:295px;width:100%;">
        <canvas id="punctualityHistoryChart" style="width:100%;max-width:420px;height:220px;"></canvas>
      </div>
    </div>
  </div>
    <script>
      // Punctuality History Chart (Right Box)
      let punctualityChartInstance = null;
      async function renderPunctualityHistoryChart(student) {
        const ctxPunctuality = document.getElementById('punctualityHistoryChart')?.getContext('2d');
        if (!ctxPunctuality || !student) return;
        // Fetch logs for this student
        try {
          // Accept relevantEvents as optional second argument
          let relevantEvents = arguments[1];
          let logs, events;
          if (!relevantEvents) {
            // Fallback: fetch all events and filter
            const [eventsRes, logsRes] = await Promise.all([
              fetch('/events'),
              fetch('/logs')
            ]);
            events = await eventsRes.json();
            logs = await logsRes.json();
            relevantEvents = events.filter(ev => window.isEventForStudent(ev, student));
          } else {
            // If relevantEvents provided, fetch logs only
            const logsRes = await fetch('/logs');
            logs = await logsRes.json();
            // For event lookup
            const eventsRes = await fetch('/events');
            events = await eventsRes.json();
          }
          // Only consider logs for relevant events (compare by event _id)
          const relevantEventIds = new Set(relevantEvents.map(ev => String(ev._id)));
        const studentLogs = logs.filter(l => String(l.fingerprintID) === String(student.FID) && l.timeIn && l.timeOut && relevantEventIds.has(String(l.event_id)));
          // Compute punctuality according to requested rules:
          // - Early: arrival before scheduled time (log time < scheduled time)
          // - On Time: arrival within 1 hour after scheduled time (0 <= diffMin <= 60)
          // - Late: arrival more than 1 hour after scheduled time (diffMin > 60)
          let early = 0, onTime = 0, late = 0;
          studentLogs.forEach(log => {
            const event = events.find(ev => String(ev._id) === String(log.event_id));
            if (!event || !event.timeStart) return;
            const schedDate = new Date(`${event.date}T${event.timeStart}`);
            const logDate = new Date(log.timeIn);
            const diffMin = (logDate - schedDate) / 60000;
            if (diffMin < 0) early++;
            else if (diffMin >= 0 && diffMin <= 60) onTime++;
            else late++;
          });
          // Colors: Early (green), On Time (teal), Late (red)
          const earlyColor = 'rgba(102,187,106,0.95)';
          const onTimeColor = 'rgba(22,160,133,0.95)';
          const lateColor = 'rgba(229,57,53,0.95)';
          // Destroy previous chart if exists
          if (punctualityChartInstance) punctualityChartInstance.destroy();
          punctualityChartInstance = new Chart(ctxPunctuality, {
            type: 'bar',
            data: {
              labels: ['Early', 'On Time', 'Late'],
              datasets: [{
                label: 'Count',
                data: [early, onTime, late],
                backgroundColor: [earlyColor, onTimeColor, lateColor],
                borderRadius: 12,
                barPercentage: 0.7,
                categoryPercentage: 0.7,
                borderSkipped: false,
                borderWidth: 0
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Punctuality History',
                  align: 'start',
                  color: '#000',
                  font: { size: 20, weight: 'bold', family: 'Segoe UI, Arial, sans-serif' },
                  padding: { top: 10, bottom: 20 }
                },
                tooltip: {
                  enabled: true,
                  backgroundColor: '#fff',
                  titleColor: '#000',
                  bodyColor: '#000',
                  borderColor: lateColor,
                  borderWidth: 1,
                  callbacks: {
                    label: function(context) {
                      return `${context.label}: ${context.parsed.x}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                    beginAtZero: true,
                    max: Math.max(4, early + onTime + late),
                    grid: { color: 'rgba(0,0,0,0.04)' },
                    ticks: {
                      color: '#000',
                      font: { size: 14 },
                      stepSize: 1,
                      callback: function(value) {
                        if (Number.isInteger(value)) return value;
                        return '';
                      }
                    }
                  },
                  y: {
                  grid: { display: false },
                  ticks: { color: '#000', font: { size: 14 } }
                }
              },
              layout: {
                padding: { left: 10, right: 10, top: 0, bottom: 0 }
              },
              animation: false
            },
            plugins: [{
                id: 'bar-value',
              afterDatasetsDraw: chart => {
                const {ctx} = chart;
                ctx.save();
                ctx.font = 'bold 16px Segoe UI, Arial, sans-serif';
                ctx.fillStyle = '#000';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                const meta = chart.getDatasetMeta(0);
                meta.data.forEach((bar, i) => {
                  const value = chart.data.datasets[0].data[i];
                  const x = bar.x + 8;
                  const y = bar.y;
                  ctx.fillText(value, x, y);
                });
                ctx.restore();
              }
            }]
          });
        } catch (err) {
          // fallback: show empty chart
          if (punctualityChartInstance) punctualityChartInstance.destroy();
          const grad = ctxPunctuality.createLinearGradient(0, 0, 420, 0);
          grad.addColorStop(0, '#4285f4');
          grad.addColorStop(1, '#7baaf7');
          punctualityChartInstance = new Chart(ctxPunctuality, {
            type: 'bar',
            data: {
              labels: ['Early', 'On Time', 'Late'],
                datasets: [{
                label: 'Count',
                data: [0, 0, 0],
                backgroundColor: [
                  'rgba(66,133,244,0.85)',
                  'rgba(66,133,244,0.85)',
                  grad
                ],
                borderRadius: 12,
                barPercentage: 0.7,
                categoryPercentage: 0.7,
                borderSkipped: false,
                borderWidth: 0
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  beginAtZero: true,
                  max: 4,
                  grid: { color: 'rgba(66,133,244,0.08)' },
                  ticks: { color: '#000', font: { size: 14 }, stepSize: 1, callback: function(v){ return Number.isInteger(v) ? v : ''; } }
                }
              }
            }
          });
        }
      }
      // Attendance Trend Chart (Student) - now dynamic from backend
      let attendanceTrendChartInstance = null;
      async function renderAttendanceTrendChart(student) {
  const ctxMonthly = document.getElementById('monthlyAttendanceTrendChart')?.getContext('2d');
  if (!ctxMonthly || !student) return;
  try {
    // Accept relevantEvents as optional second argument
    let events = arguments[1];
    let logs;
    if (!events) {
      // Fallback: fetch all events and filter
      const [eventsRes, logsRes] = await Promise.all([
        fetch('/events'),
        fetch('/logs')
      ]);
      events = await eventsRes.json();
      logs = await logsRes.json();
  // Filter events to only those that include this student (by section, explicit STUDENT NO, or ALL)
  events = events.filter(ev => window.isEventForStudent(ev, student));
    } else {
      // If events provided, fetch logs only
  const logsRes = await fetch('/logs');
  logs = await logsRes.json();
    }
    // For each event, check if student attended (has log with timeIn for this event and fingerprintID)
    const labels = events.map(ev => ev.name);
    const data = events.map(ev => {
  const attended = logs.find(l => String(l.event_id) === String(ev._id) && String(l.fingerprintID) === String(student.FID) && l.timeIn && l.timeOut);
      return attended ? 1 : 0;
    });
    // Destroy previous chart if exists
    if (attendanceTrendChartInstance) attendanceTrendChartInstance.destroy();
    attendanceTrendChartInstance = new Chart(ctxMonthly, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Attendance',
          data: data,
          fill: true,
          borderColor: '#4285f4',
          backgroundColor: 'rgba(66,133,244,0.08)',
          pointBackgroundColor: '#4285f4',
          pointBorderColor: '#fff',
          pointRadius: 5,
          pointHoverRadius: 7,
          tension: 0.45,
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Attendance Trend',
            align: 'start',
            color: '#000',
            font: { size: 20, weight: 'bold', family: 'Segoe UI, Arial, sans-serif' },
            padding: { top: 10, bottom: 20 }
          },
          tooltip: {
            backgroundColor: '#fff',
            titleColor: '#000',
            bodyColor: '#000',
            borderColor: '#4285f4',
            borderWidth: 1,
            padding: 12,
            caretSize: 8,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.parsed.y === 1 ? 'Attended' : 'Absent';
              }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#000', font: { size: 14 } }
          },
          y: {
            min: 0,
            max: 1,
            grid: { color: 'rgba(66,133,244,0.08)' },
            ticks: {
              color: '#000',
              font: { size: 14 },
              stepSize: 1,
              callback: function(value) {
                if (value === 1) return 'Attended';
                if (value === 0) return 'Absent';
                return '';
              }
            }
          }
        },
        layout: {
          padding: { left: 10, right: 10, top: 0, bottom: 0 }
        }
      }
    });
  } catch (err) {
    // fallback: show empty chart
    if (attendanceTrendChartInstance) attendanceTrendChartInstance.destroy();
    attendanceTrendChartInstance = new Chart(ctxMonthly, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Attendance',
          data: [],
          fill: true,
          borderColor: '#4285f4',
          backgroundColor: 'rgba(66,133,244,0.08)',
          pointBackgroundColor: '#4285f4',
          pointBorderColor: '#fff',
          pointRadius: 5,
          pointHoverRadius: 7,
          tension: 0.45,
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
      }
  // Call renderAttendanceTrendChart(student) and renderPunctualityHistoryChart(student) in showStudent(student)
  // (Assumes showStudent is called when a student is selected)
  // Find showStudent and add call:
  // Patch showStudent to update attendance trend and punctuality chart
  // (If showStudent is defined elsewhere, ensure this is added after its definition)
  // No need to patch showStudent, now always calls renderAttendanceTrendChart and renderPunctualityHistoryChart
      // Simple donut chart for attendance
      const donut = document.getElementById('attendanceDonutChart');
      if (donut) {
        const ctx = donut.getContext('2d');
        const percent = 78.5;
        const angle = percent / 100 * 2 * Math.PI;
        // Draw background
        ctx.beginPath();
        ctx.arc(70, 70, 60, 0, 2 * Math.PI);
        ctx.strokeStyle = '#eaeaea';
        ctx.lineWidth = 14;
        ctx.stroke();
        // Draw foreground
        ctx.beginPath();
        ctx.arc(70, 70, 60, -Math.PI / 2, angle - Math.PI / 2);
        ctx.strokeStyle = '#e53950';
        ctx.lineWidth = 14;
        ctx.stroke();
      }
    </script>
    <script>
    // Auto-refresh helpers for student analytics charts
    let _studentAnalyticsInterval = null;
    function startStudentAnalyticsAutoRefresh(student, relevantEvents) {
      // Clear any existing interval
      stopStudentAnalyticsAutoRefresh();
      // Refresh every 8 seconds while viewing this student
      _studentAnalyticsInterval = setInterval(() => {
        try {
          renderAttendanceTrendChart(student, relevantEvents);
          renderPunctualityHistoryChart(student, relevantEvents);
        } catch (e) {
          console && console.error && console.error('Auto-refresh error', e);
        }
      }, 8000);
    }
    function stopStudentAnalyticsAutoRefresh() {
      if (_studentAnalyticsInterval) {
        clearInterval(_studentAnalyticsInterval);
        _studentAnalyticsInterval = null;
      }
    }
    // Stop auto-refresh when navigating away from the student analytics section
    document.getElementById('studentAnalyticsBtn')?.addEventListener('click', () => {
      stopStudentAnalyticsAutoRefresh();
    });
    </script>
    </div>

    <script>
  // Chart.js for General Reports (fetches backend data)
    document.addEventListener("DOMContentLoaded", function() {
      const generalAnalyticsCard = document.getElementById("generalAnalyticsCard");
      const chartWrap = document.getElementById("generalAnalyticsChartWrap");
      const chartCanvas = document.getElementById("generalAnalyticsChart");
      const eventDistributionChartWrap = document.getElementById("eventDistributionChartWrap");
      let chartInstance = null;
      if (generalAnalyticsCard && chartWrap && chartCanvas) {
        // Show General Analytics chart automatically
        (async function() {
          chartWrap.style.display = "block";
          try {
            const eventsRes = await fetch('/events');
            const events = await eventsRes.json();
            const attendanceCounts = await Promise.all(events.map(async ev => {
              const logsRes = await fetch(`/logs?eventId=${ev._id}`);
              const logs = await logsRes.json();
              // Count unique fingerprintIDs with both timeIn and timeOut
              const attended = Array.isArray(logs) ? logs.filter(l => l.timeIn && l.timeOut).map(l => l.fingerprintID) : [];
              const uniqueAttended = new Set(attended);
              return uniqueAttended.size;
            }));
            const labels = events.map(ev => ev.name);
            const data = attendanceCounts;
            chartInstance = new Chart(chartCanvas, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [{
                  label: "Attendance Level",
                  data: data,
                  backgroundColor: "#1abc9c",
                  borderRadius: 8,
                  maxBarThickness: 48
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: { display: false },
                  title: {
                    display: true,
                    text: "Attendance Level per Event",
                    font: { size: 18 }
                  }
                },
                scales: {
                  x: {
                    title: { display: true, text: "Events" },
                    grid: { display: false }
                  },
                  y: {
                    title: { display: true, text: "Attendance Level" },
                    beginAtZero: true,
                    grid: { color: "#eef2f6" }
                  }
                }
              }
            });
          } catch (err) {
            chartCanvas.parentElement.innerHTML = `<div style='color:red;text-align:center;margin-top:24px;'>Failed to load analytics chart.</div>`;
          }
        })();
      }

      // Chart.js for Event Distribution (donut graph, backend data)
      const eventDistributionCard = document.getElementById("eventDistributionCard");
      const donutChartWrap = document.getElementById("eventDistributionChartWrap");
      const donutChartCanvas = document.getElementById("eventDistributionDonutChart");
      const eventFilter = document.getElementById("eventDistributionEventFilter");
      let donutChartInstance = null;
      let eventsList = [];
      let studentsList = [];
      const sectionLabels = [];

      // Fetch events and students for filter and section labels
      async function fetchEventsAndStudents() {
        try {
          const [eventsRes, studentsRes] = await Promise.all([
            fetch('/events'),
            fetch('/students')
          ]);
          eventsList = await eventsRes.json();
          studentsList = await studentsRes.json();
          // Get unique section labels from students
          const secSet = new Set();
          studentsList.forEach(s => {
            if (s["YR AND SEC"]) secSet.add(s["YR AND SEC"]);
          });
          sectionLabels.length = 0;
          sectionLabels.push(...Array.from(secSet).sort());
          // Populate event filter
          let options = '<option value="ALL">All</option>';
          eventsList.forEach(ev => {
            options += `<option value="${ev._id}">${ev.name}</option>`;
          });
          eventFilter.innerHTML = options;
        } catch (err) {
          eventFilter.innerHTML = '<option value="ALL">All</option>';
        }
      }

      // Render donut chart for selected event or all events
      async function renderDonutChart(eventId) {
        let labels = sectionLabels;
        let data = sectionLabels.map(() => 0);
        let title = "Attendance Distribution per Section";
        if (eventId === "ALL") {
          // For all events, sum attendance per section
          let sectionCounts = sectionLabels.map(() => 0);
          await Promise.all(eventsList.map(async ev => {
            const logsRes = await fetch(`/logs?eventId=${ev._id}`);
            const logs = await logsRes.json();
            // Group logs by fingerprintID
            const logsByFID = {};
            logs.forEach(log => {
              if (!logsByFID[log.fingerprintID]) logsByFID[log.fingerprintID] = [];
              logsByFID[log.fingerprintID].push(log);
            });
            Object.entries(logsByFID).forEach(([fid, logsArr]) => {
              // Find a log for this fingerprintID with both timeIn and timeOut
              const validLog = logsArr.find(l => l.timeIn && l.timeOut);
              if (validLog) {
                const student = studentsList.find(s => s.FID === validLog.fingerprintID);
                if (student && student["YR AND SEC"]) {
                  const idx = sectionLabels.indexOf(student["YR AND SEC"]);
                  if (idx !== -1) sectionCounts[idx]++;
                }
              }
            });
          }));
          data = sectionCounts;
          title = "Attendance Distribution per Section (All Events)";
        } else {
          // For selected event, fetch logs and count by section
          const logsRes = await fetch(`/logs?eventId=${eventId}`);
          const logs = await logsRes.json();
          // Group logs by fingerprintID
          const logsByFID = {};
          logs.forEach(log => {
            if (!logsByFID[log.fingerprintID]) logsByFID[log.fingerprintID] = [];
            logsByFID[log.fingerprintID].push(log);
          });
          let sectionCounts = sectionLabels.map(() => 0);
          Object.entries(logsByFID).forEach(([fid, logsArr]) => {
            const validLog = logsArr.find(l => l.timeIn && l.timeOut);
            if (validLog) {
              const student = studentsList.find(s => s.FID === validLog.fingerprintID);
              if (student && student["YR AND SEC"]) {
                const idx = sectionLabels.indexOf(student["YR AND SEC"]);
                if (idx !== -1) sectionCounts[idx]++;
              }
            }
          });
          data = sectionCounts;
          const eventObj = eventsList.find(ev => ev._id === eventId);
          title = eventObj ? `Attendance Distribution for ${eventObj.name}` : "Attendance Distribution";
        }
        if (donutChartInstance) {
          donutChartInstance.destroy();
        }
        donutChartInstance = new Chart(donutChartCanvas, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [{
              label: "Attendance Distribution",
              data: data,
              backgroundColor: [
                "#2563EB", // Royal Blue
                "#10B981", // Emerald Green
                "#6366F1", // Indigo Purple
                "#F59E0B", // Amber Orange
                "#EF4444", // Coral Red
                "#FACC15", // Golden Yellow
                "#0EA5E9", // Sky Blue
                "#374151"  // Slate Gray
              ].slice(0, labels.length),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: "bottom"
              },
              title: {
                display: true,
                text: title,
                font: { size: 18 }
              }
            }
          }
        });
      }

      if (eventDistributionCard && donutChartWrap && donutChartCanvas && eventFilter) {
        // Show Event Distribution chart automatically
        (async function() {
          donutChartWrap.style.display = "block";
          await fetchEventsAndStudents();
          await renderDonutChart(eventFilter.value);
        })();
        eventFilter.addEventListener("change", async function() {
          await renderDonutChart(eventFilter.value);
        });
      }
    });
    </script>
  </section>
    </main>
  </div>

  <script>
    // LOGIN LOGIC (two-step email -> code)
    document.addEventListener("DOMContentLoaded", function() {
      const loginForm = document.getElementById("loginForm");
      const loginMsg = document.getElementById("loginMsg");
      const loginContainer = document.getElementById("loginContainer");
      const dashboardContainer = document.getElementById("dashboardContainer");
      const sendCodeBtn = document.getElementById("sendCodeBtn");
      const verifyCodeBtn = document.getElementById("verifyCodeBtn");
      const codeRow = document.getElementById("codeRow");

      // Always show login page first on refresh
      localStorage.removeItem("authToken");
      loginContainer.style.display = "flex";
      dashboardContainer.style.display = "none";

      // Helper to show messages
      function showMsg(text, isError = true) {
        loginMsg.style.color = isError ? 'red' : 'green';
        loginMsg.textContent = text;
      }

      // resend timer state
      let resendInterval = null;
      let resendRemaining = 0;
      const resendBtn = document.getElementById('resendBtn');

      function formatMMSS(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
      }

      function startResendTimer(seconds) {
        clearInterval(resendInterval);
        resendRemaining = seconds;
        resendBtn.disabled = true;
        resendBtn.textContent = `Resend in ${formatMMSS(resendRemaining)}`;
        // style disabled look
        resendBtn.style.opacity = '0.7';
        resendBtn.style.background = '#f0f0f0';
        resendBtn.style.color = '#333';
        resendBtn.style.border = '1px solid #ddd';
        resendInterval = setInterval(() => {
          resendRemaining -= 1;
          if (resendRemaining <= 0) {
            clearInterval(resendInterval);
            resendBtn.disabled = false;
            resendBtn.textContent = 'Resend';
            // make resend button green and prominent when re-enabled
            resendBtn.style.opacity = '1';
            resendBtn.style.background = '#1abc9c';
            resendBtn.style.color = '#fff';
            resendBtn.style.border = 'none';
          } else {
            resendBtn.textContent = `Resend in ${formatMMSS(resendRemaining)}`;
          }
        }, 1000);
      }

      async function doSendCode(email) {
        // New behavior: call /login with email+password (simple auth) and handle token.
        const password = document.getElementById('loginPassword').value || '';
        showMsg('Signing in...', false);
        try {
          const res = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
          const j = await res.json();
          if (res.ok && j.token) {
            localStorage.setItem('authToken', j.token);
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            if (loginContainer) loginContainer.style.display = 'none';
            if (dashboardContainer) dashboardContainer.style.display = 'flex';
            showMsg('Signed in', false);
            return;
          } else {
            showMsg(j.error || 'Invalid credentials.');
          }
        } catch (e) { showMsg('Error: ' + (e.message || e)); }
      }

      sendCodeBtn.addEventListener('click', async function () {
        const email = document.getElementById('loginEmail').value.trim();
        if (!email) return showMsg('Please enter your email and password.');
        await doSendCode(email);
      });

      resendBtn.addEventListener('click', async function () {
        // resend only when enabled
        if (resendBtn.disabled) return;
        const email = document.getElementById('loginEmail').value.trim() || document.getElementById('loginEmail').value;
        // if email field hidden, attempt to read from prompt text
        let targetEmail = email;
        if (!targetEmail) {
          const cp = document.getElementById('codePrompt').textContent || '';
          const m = cp.match(/to\s+(\S+)/);
          if (m) targetEmail = m[1];
        }
        if (!targetEmail) return showMsg('Unable to determine email for resend.');
        await doSendCode(targetEmail);
      });

      verifyCodeBtn.addEventListener('click', async function () {
        const email = document.getElementById('loginEmail').value.trim();
        const code = document.getElementById('loginCode').value.trim();
        if (!email || !code) return showMsg('Please provide email and 6-digit code.');
        showMsg('Verifying...', false);
        try {
          const res = await fetch('/verify-code', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, code })
          });
          const j = await res.json();
          if (res.ok && j.token) {
            localStorage.setItem('authToken', j.token);
            loginContainer.style.display = 'none';
            dashboardContainer.style.display = 'flex';
          } else {
            showMsg(j.error || 'Invalid code.');
          }
        } catch (e) { showMsg('Error: ' + (e.message || e)); }
      });
    });
    // Event management state
    let eventsCache = [];
    let selectedEventId = null;
    let attendanceModalOpen = false;


    // Fetch events and update dropdown
    async function updateEventsCache() {
      try {
  const res = await fetch('/events');
        eventsCache = await res.json();
        renderEventListTable();
      } catch (err) {
        console.error("Error fetching events:", err);
        eventsCache = [];
        renderEventListTable();
      }
    }

    // Initial event cache load
    document.addEventListener("DOMContentLoaded", function() {
      updateEventsCache();
    });
    setInterval(() => updateEventsCache(), 10000);

    // Handle event selection
    // No event select dropdown anymore

    // Add event form
    document.addEventListener("DOMContentLoaded", function() {
      const eventForm = document.getElementById("eventForm");
      const eventMsg = document.getElementById("eventMsg");
      if (eventForm) {
        eventForm.addEventListener("submit", async function(e) {
        e.preventDefault();
        const name = document.getElementById("eventName").value;
        const date = document.getElementById("eventDate").value;
        eventMsg.textContent = "";
        if (!name || !date) {
          eventMsg.textContent = "Please enter both event name and date.";
          eventMsg.style.color = "red";
          return;
        }
        try {
          const res = await fetch('/events', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, date })
          });
          if (res.ok) {
            eventMsg.textContent = "Event added!";
            eventForm.reset();
            await updateEventsCache();
          } else {
            const err = await res.json();
            eventMsg.textContent = err.error || "Failed to add event.";
            eventMsg.style.color = "red";
          }
        } catch (error) {
          eventMsg.textContent = "Error: " + error.message;
          eventMsg.style.color = "red";
        }
        setTimeout(() => {
          eventMsg.textContent = "";
          eventMsg.style.color = "green";
        }, 3000);
      });
      }
    });

    // Students cache
    let studentsCache = [];
    async function updateStudentsCache() {
      try {
  const res = await fetch('/students');
        studentsCache = await res.json();
      } catch (err) {
        studentsCache = [];
      }
    }
    updateStudentsCache();
    setInterval(updateStudentsCache, 10000);

    // Manual log entry
    document.addEventListener("DOMContentLoaded", function() {
      const fingerprintInput = document.getElementById("fingerprintID");
      const nameInput = document.getElementById("name");
      if (fingerprintInput && nameInput) {
        fingerprintInput.addEventListener("input", function() {
          const id = fingerprintInput.value;
          // Use FID and NAME fields from backend
          const student = studentsCache.find(s => String(s.FID) === String(id));
          nameInput.value = student ? student.NAME : "";
        });
      }

      const logForm = document.getElementById("logForm");
      const msg = document.getElementById("logMsg");

      if (logForm) {
        logForm.addEventListener("submit", async function(e) {
          e.preventDefault();
          const fingerprintID = document.getElementById("fingerprintID") ? document.getElementById("fingerprintID").value : "";
          const student = studentsCache.find(s => String(s.FID) === String(fingerprintID));
          const name = student ? student.NAME : "";
          if (!name) {
            msg.textContent = "No student found for this Fingerprint ID.";
            msg.style.color = "red";
            setTimeout(() => { msg.textContent = ""; msg.style.color = "green"; }, 3000);
            return;
          }
          if (!selectedEventId) {
            msg.textContent = "No event selected.";
            msg.style.color = "red";
            setTimeout(() => { msg.textContent = ""; msg.style.color = "green"; }, 3000);
            return;
          }

          try {
            const res = await fetch('/log', {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ fingerprintID, name, eventId: selectedEventId })
            });
            if (res.ok) {
              msg.textContent = "Log added!";
              await fetchEventManagement();
              logForm.reset();
            } else {
              const err = await res.json();
              msg.textContent = err.error || "Failed to add log.";
              msg.style.color = "red";
            }
          } catch (error) {
            msg.textContent = "Error: " + error.message;
            msg.style.color = "red";
          }
          setTimeout(() => { msg.textContent = ""; msg.style.color = "green"; }, 3000);
        });
      }
    });

    // Event management view
    // Render event list table
    function renderEventListTable() {
      const table = document.getElementById("eventListTable");
      table.innerHTML = "";
      if (!eventsCache || eventsCache.length === 0) {
        table.innerHTML = "<tr style='height:44px;'>"
          + "<th style='padding:4px 6px; min-width:120px; max-width:120px; width:120px;'>Event Name</th>"
          + "<th style='padding:4px 6px; min-width:100px; max-width:100px; width:100px;'>Date</th>"
          + "<th style='padding:4px 6px; min-width:110px; max-width:110px; width:110px;'>Time</th>"
          + "<th style='padding:4px 12px; min-width:220px; max-width:320px; width:260px;'>Participants</th>"
          + "<th style='padding:4px 4px; min-width:110px; max-width:110px; width:110px; font-size:0.85em; white-space:nowrap;'>Attendance Sheet</th>"
          + "<th style='padding:4px 4px; min-width:90px; max-width:90px; width:90px;'>Edit</th>"
          + "</tr>"
          + "<tr><td colspan='6'>No events found.</td></tr>";
        return;
      }
      eventsCache.forEach(ev => {
        const timeStr = (ev.timeStart && ev.timeEnd) ? `${ev.timeStart} - ${ev.timeEnd}` : '';
        let participantsStr = '';
        if (Array.isArray(ev.participants)) {
          participantsStr = ev.participants.join(', ');
        } else if (ev.participants && typeof ev.participants === 'object') {
          const parts = [];
          if (Array.isArray(ev.participants.sections) && ev.participants.sections.length) parts.push(ev.participants.sections.join(', '));
          if (Array.isArray(ev.participants.students) && ev.participants.students.length) parts.push(ev.participants.students.join(', '));
          participantsStr = parts.join(' | ');
        }
        const activeClass = ev.active ? 'active-event' : '';
        const row = `<tr class='${activeClass}' style='height:44px;'>
          <td style='padding:4px 6px; min-width:120px; max-width:120px; width:120px;'>${ev.name}</td>
          <td style='padding:4px 6px; min-width:100px; max-width:100px; width:100px;'>${ev.date}</td>
          <td style='padding:4px 6px; min-width:110px; max-width:110px; width:110px;'>${timeStr}</td>
          <td style='padding:4px 12px; min-width:220px; max-width:320px; width:260px; word-break:break-word;'>${participantsStr}</td>
          <td style='padding:4px 4px; text-align:center; height:44px; min-width:110px; max-width:110px; width:110px;'>
            <div style="display:flex;align-items:center;justify-content:center;height:44px;">
              <button class='attendanceSheetBtn' data-id='${ev._id}' style='padding:4px 10px;font-size:0.85em;white-space:nowrap;'>Attendance Sheet</button>
            </div>
          </td>
          <td style='text-align:center;padding:4px 4px; height:44px; min-width:90px; max-width:90px; width:90px;'>
            <div style="display:flex;align-items:center;justify-content:center;height:44px;">
              <button class='editEventBtn' data-id='${ev._id}' data-name='${ev.name}' data-date='${ev.date}' data-timestart='${ev.timeStart || ''}' data-timeend='${ev.timeEnd || ''}' data-participants='${typeof ev.participants === 'object' ? JSON.stringify(ev.participants).replace(/'/g, "\\'") : (Array.isArray(ev.participants) ? ev.participants.join("|") : '')}' title='Edit Event' style='background:none;border:none;cursor:pointer;padding:2px 4px;'>
                <img src='https://img.icons8.com/office/40/edit.png' alt='Edit' style='width:20px;height:20px;vertical-align:middle;' />
              </button>
            </div>
          </td>
        </tr>`;
        table.innerHTML += row;
      });
      // Attach listeners for new buttons
      document.querySelectorAll('.editEventBtn').forEach(btn => {
        btn.onclick = function() {
          // Remove any existing popup
          const old = document.getElementById('eventActionPopup');
          if (old) old.remove();
          // Create popup
          const popup = document.createElement('div');
          popup.id = 'eventActionPopup';
          popup.style.position = 'fixed';
          popup.style.top = '0';
          popup.style.left = '0';
          popup.style.width = '100vw';
          popup.style.height = '100vh';
          popup.style.background = 'rgba(0,0,0,0.15)';
          popup.style.display = 'flex';
          popup.style.alignItems = 'center';
          popup.style.justifyContent = 'center';
          popup.style.zIndex = '9999';

          // Parse participants for pre-selection
          let allSections = [];
          if (window.studentsCache && Array.isArray(window.studentsCache)) {
            const secSet = new Set();
            window.studentsCache.forEach(s => { if (s["YR AND SEC"]) secSet.add(s["YR AND SEC"]); });
            allSections = Array.from(secSet).sort();
          }
          allSections = ['ALL', ...allSections];
          const currentParticipants = (btn.getAttribute('data-participants') || '').split('|').filter(Boolean);
          // If "ALL" is present, only select ALL
          let selectedSections = currentParticipants.includes('ALL') ? ['ALL'] : currentParticipants;

          popup.innerHTML = `
            <div style="background:#fff;padding:32px 24px;border-radius:8px;box-shadow:0 2px 12px rgba(44,62,80,0.07);min-width:340px;max-width:90vw;">
              <h3 style='margin-top:0; margin-bottom:18px; color:#1abc9c; font-size:1.3em; font-weight:700;'>Edit Event</h3>
              <div style='margin-bottom:14px;'>
                <label style='font-weight:600;'>Event Name</label>
                <input type='text' id='editEventName' value='${btn.getAttribute('data-name')}' style='width:100%;padding:8px 10px;margin-bottom:10px;'>
                <label style='font-weight:600;'>Event Date</label>
                <input type='date' id='editEventDate' value='${btn.getAttribute('data-date')}' style='width:100%;padding:8px 10px;'>
                <div style='display:flex;flex-direction:row;gap:10px;margin-top:10px;'>
                  <div style='display:flex;flex-direction:column;gap:6px;flex:1;'>
                    <label for='editEventTimeStart' style='font-weight:600;'>Start Time</label>
                    <input type='time' id='editEventTimeStart' value='${btn.getAttribute('data-timestart') || ''}' style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                  <div style='display:flex;flex-direction:column;gap:6px;flex:1;'>
                    <label for='editEventTimeEnd' style='font-weight:600;'>End Time</label>
                    <input type='time' id='editEventTimeEnd' value='${btn.getAttribute('data-timeend') || ''}' style='padding:8px 10px;font-size:1em;border:1.5px solid #1abc9c;border-radius:6px;'>
                  </div>
                </div>
                <div style='display:flex;flex-direction:column;gap:6px;margin-top:10px;'>
                  <label style='font-weight:600;'>Participants (Section)</label>
                  <div id='editEventParticipantsOptions' style='display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;'></div>
                  <span style='font-size:0.92em;color:#888;margin-top:2px;'>Click sections to select. Selected sections are highlighted. Selecting "All" overrides other selections.</span>
                </div>
                <div style='display:flex;flex-direction:column;gap:6px;margin-top:8px;'>
                  <label style='font-weight:600;'>Participants (By Student Number)</label>
                  <div style='display:flex;gap:8px;align-items:center;'>
                    <input type='text' id='editParticipantStudentNoInput' placeholder='e.g. M2022-1001' style='flex:1;padding:8px;border:1px solid #dcdcdc;border-radius:6px;font-size:0.95em;' />
                    <button type='button' id='editAddParticipantStudentBtn' style='background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 12px;font-weight:600;'>Add</button>
                  </div>
                  <div id='editSelectedStudentParticipants' style='display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;'></div>
                </div>
              </div>
              <div style='display:flex;justify-content:flex-end;gap:10px;'>
                <button id='saveEventBtn' style='background:#1abc9c;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:600;'>Save</button>
                <button id='deleteEventBtn' style='background:#e74c3c;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:600;'>Delete</button>
                <button id='closeEventPopupBtn' style='background:#bbb;color:#fff;padding:8px 18px;border:none;border-radius:6px;font-weight:600;'>Cancel</button>
              </div>
              <div id='editEventMsg' style='margin-top:12px;color:green;'></div>
            </div>
          `;
          document.body.appendChild(popup);
          document.getElementById('closeEventPopupBtn').onclick = () => popup.remove();

          // Participants highlight-style selector logic
          window._editEventParticipantsSelected = [...selectedSections];
          // Specific students for edit popup
          window._editEventSpecificStudents = [];
          // Try to parse event participants from data attribute (supports previous array style or object)
          try {
            const raw = btn.getAttribute('data-participants') || '';
            if (raw && raw.includes('{') && raw.includes('students')) {
              // may be stored as JSON string in DB
              const parsed = JSON.parse(raw);
              if (parsed && Array.isArray(parsed.students)) window._editEventSpecificStudents = [...parsed.students];
              if (parsed && Array.isArray(parsed.sections)) window._editEventParticipantsSelected = [...parsed.sections];
            }
          } catch (e) { /* ignore parse errors */ }
          function renderEditOptions() {
            const opts = document.getElementById('editEventParticipantsOptions');
            opts.innerHTML = '';
            allSections.forEach(sec => {
              const btnEl = document.createElement('button');
              btnEl.type = 'button';
              btnEl.textContent = sec;
              const isSelected = window._editEventParticipantsSelected.includes(sec);
              btnEl.style.cssText = `background:${isSelected ? '#1abc9c' : '#eafaf6'};color:${isSelected ? '#fff' : '#1a2233'};padding:5px 14px;border-radius:12px;border:none;font-size:0.98em;cursor:pointer;transition:background 0.2s;outline:${isSelected ? '2px solid #159c85' : 'none'};`;
              btnEl.onclick = function() {
                if (isSelected) {
                  window._editEventParticipantsSelected = window._editEventParticipantsSelected.filter(s => s !== sec);
                } else if (sec === 'ALL') {
                  window._editEventParticipantsSelected = ['ALL'];
                } else {
                  window._editEventParticipantsSelected = window._editEventParticipantsSelected.filter(s => s !== 'ALL');
                  window._editEventParticipantsSelected.push(sec);
                }
                renderEditOptions();
              };
              opts.appendChild(btnEl);
            });
          }
          renderEditOptions();

          // render specific student chips
          function renderEditSelectedStudents() {
            const container = document.getElementById('editSelectedStudentParticipants');
            container.innerHTML = '';
            (window._editEventSpecificStudents || []).forEach(sn => {
              const chip = document.createElement('div');
              chip.style.cssText = 'background:#f1f5f9;border:1px solid #dfe7ef;padding:6px 10px;border-radius:12px;font-size:0.95em;display:flex;align-items:center;gap:8px;';
              chip.textContent = sn;
              const remove = document.createElement('button');
              remove.type = 'button'; remove.textContent = 'Ã—';
              remove.style.cssText = 'background:transparent;border:none;color:#666;font-weight:700;cursor:pointer;padding:0 6px;font-size:1.05em;line-height:1;';
              remove.onclick = () => { window._editEventSpecificStudents = window._editEventSpecificStudents.filter(x => x !== sn); renderEditSelectedStudents(); };
              chip.appendChild(remove);
              container.appendChild(chip);
            });
          }
          renderEditSelectedStudents();

          // edit-specific student add button
          document.getElementById('editAddParticipantStudentBtn').addEventListener('click', async function() {
            const val = (document.getElementById('editParticipantStudentNoInput').value || '').trim();
            if (!val) return;
            // resolve from cache or backend
            let found = null;
            if (window.studentsCache && Array.isArray(window.studentsCache)) {
              found = window.studentsCache.find(s => String(s['STUDENT NO']).toLowerCase() === val.toLowerCase());
            }
            if (!found) {
              try {
                const res = await fetch('/students');
                if (res.ok) {
                  const list = await res.json();
                  found = list.find(s => String(s['STUDENT NO']).toLowerCase() === val.toLowerCase());
                }
              } catch (e) {}
            }
            if (!found) return alert('Student not found: ' + val);
            const sn = String(found['STUDENT NO']);
            if (!window._editEventSpecificStudents.includes(sn)) {
              window._editEventSpecificStudents.push(sn);
              renderEditSelectedStudents();
            }
            document.getElementById('editParticipantStudentNoInput').value = '';
          });

          document.getElementById('saveEventBtn').onclick = async () => {
            const newName = document.getElementById('editEventName').value.trim();
            const newDate = document.getElementById('editEventDate').value;
            const newTimeStart = document.getElementById('editEventTimeStart').value;
            const newTimeEnd = document.getElementById('editEventTimeEnd').value;
            const newParticipantsSections = window._editEventParticipantsSelected || [];
            const newParticipantsStudents = window._editEventSpecificStudents || [];
            const msg = document.getElementById('editEventMsg');
            msg.textContent = '';
            if (!newName || !newDate || !newTimeStart || !newTimeEnd || (newParticipantsSections.length === 0 && newParticipantsStudents.length === 0)) {
              msg.textContent = 'Please fill in all fields.';
              msg.style.color = 'red';
              return;
            }
            try {
              const res = await fetch(`/events/${btn.getAttribute('data-id')}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, date: newDate, timeStart: newTimeStart, timeEnd: newTimeEnd, participants: { sections: newParticipantsSections, students: newParticipantsStudents } })
              });              let result;
              let isJson = true;
              try {
                result = await res.json();
              } catch (e) {
                isJson = false;
                result = null;
              }
              if (res.ok) {
                msg.textContent = 'Event updated successfully!';
                msg.style.color = 'green';
                popup.remove();
                await updateEventsCache();
              } else {
                if (!isJson) {
                  msg.textContent = 'Server error: Invalid response. Please check backend.';
                } else {
                  msg.textContent = result && result.error ? result.error : 'Failed to update event.';
                }
                msg.style.color = 'red';
              }
            } catch (error) {
              msg.textContent = 'Error: ' + error.message;
              msg.style.color = 'red';
            }
          };
          document.getElementById('deleteEventBtn').onclick = async () => {
            if (confirm('Are you sure you want to delete this event?')) {
              try {
                const res = await fetch(`/events/${btn.getAttribute('data-id')}`, { method: 'DELETE' });
                let result;
                if (res.ok) {
                  result = await res.json();
                  document.getElementById('editEventMsg').textContent = 'Event deleted successfully!';
                  document.getElementById('editEventMsg').style.color = 'green';
                  popup.remove();
                  // Remove from cache and re-render table immediately
                  eventsCache = eventsCache.filter(ev => String(ev._id) !== String(btn.getAttribute('data-id')));
                  renderEventListTable();
                } else {
                  try {
                    result = await res.json();
                  } catch {
                    result = { error: 'Server error' };
                  }
                  document.getElementById('editEventMsg').textContent = result.error || 'Failed to delete event.';
                  document.getElementById('editEventMsg').style.color = 'red';
                }
              } catch (error) {
                document.getElementById('editEventMsg').textContent = 'Error: ' + error.message;
                document.getElementById('editEventMsg').style.color = 'red';
              }
            }
          };
        };
      });
      // Attach listeners
      document.querySelectorAll('.attendanceSheetBtn').forEach(btn => {
        btn.onclick = function() {
          showAttendanceSheetModal(btn.getAttribute('data-id'));
        };
      });
    }

    // Show attendance sheet modal for event
    async function showAttendanceSheetModal(eventId) {
      attendanceModalOpen = true;
      selectedEventId = eventId;
      // Find event name from eventsCache
      let eventName = '';
      if (window.eventsCache && Array.isArray(window.eventsCache)) {
        const ev = window.eventsCache.find(e => String(e._id) === String(eventId));
        if (ev) eventName = ev.name;
      }
      const modal = document.getElementById('attendanceSheetModal');
      modal.style.display = 'flex';
      modal.innerHTML = `<div style='
        background:#fff;
        padding:24px 20px 20px 20px;
        border-radius:14px;
        box-shadow:0 2px 12px rgba(44,62,80,0.07);
        min-width:340px;
        max-width:700px;
        width:100%;
        max-height:90vh;
        overflow:auto;
        border:1px solid #e1e4e8;
        display:flex;
        flex-direction:column;
        align-items:stretch;'>
        <div style='display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;'>
          <h3 style='margin:0; color:#1abc9c; font-size:1.5em; font-weight:700; letter-spacing:1px;'>Attendance Sheet</h3>
          <button id='printAttendanceBtn' style='background:#1abc9c; color:#fff; border:none; padding:8px 14px; border-radius:6px; font-size:0.95em; font-weight:600; cursor:pointer;'>Print</button>
        </div>
        <div style='margin-bottom:10px; color:#2563eb; font-size:1.05em; font-weight:600;'>${eventName ? 'Event: ' + eventName : ''}</div>
        <div style='margin-bottom:18px; display:flex; align-items:center; gap:10px;'>
          <label for='attendanceYrSecFilter' style='font-weight:400; color:#34495e; margin-right:8px; font-family:Arial, Helvetica, sans-serif;'>Filter</label>
          <select id='attendanceYrSecFilter' style='width:160px; height:38px; padding:6px;border:1px solid #ddd;border-radius:6px; box-sizing:border-box;'></select>
          <div id='manualLoggingWrap' style='display:flex;align-items:center;gap:8px;margin-left:6px;'></div>
        </div>
        <div id='attendanceSheetTableWrap' style='margin-bottom:18px;'></div>
        <button id='closeAttendanceModalBtn' style='margin-top:10px; background:#bbb; color:#fff; border:none; padding:10px 24px; border-radius:6px; cursor:pointer; font-size:1em; font-weight:600;'>Close</button>
      </div>`;
      // We'll wire up printing and filtering after loading students/logs so they operate on the event's participants
      document.getElementById('closeAttendanceModalBtn').onclick = () => {
        modal.style.display = 'none';
        attendanceModalOpen = false;
      };
      // Load students and logs, then setup filter and table
      const [studentsRes, logsRes] = await Promise.all([
  fetch('/students'),
  fetch(`/logs?eventId=${eventId}`)
      ]);
  const allStudents = await studentsRes.json();
  let logs = await logsRes.json();

      // Normalize event participants (supports legacy array or new object)
      let participantsNorm = { sections: [], students: [] };
      try {
        // Try common caches first
        let ev = null;
        if (typeof eventsCache !== 'undefined' && Array.isArray(eventsCache)) {
          ev = eventsCache.find(e => String(e._id) === String(eventId));
        }
        if (!ev && window.eventsCache && Array.isArray(window.eventsCache)) {
          ev = window.eventsCache.find(e => String(e._id) === String(eventId));
        }
        // Fallback: fetch events from server and find the event
        if (!ev) {
          try {
            const allEvRes = await fetch('/events');
            if (allEvRes.ok) {
              const allEv = await allEvRes.json();
              if (Array.isArray(allEv)) ev = allEv.find(e => String(e._id) === String(eventId));
            }
          } catch (e) { /* ignore fetch errors */ }
        }
        const raw = ev && ev.participants ? ev.participants : null;
        if (Array.isArray(raw)) {
          participantsNorm.sections = raw;
        } else if (raw && typeof raw === 'object') {
          participantsNorm.sections = Array.isArray(raw.sections) ? raw.sections : [];
          participantsNorm.students = Array.isArray(raw.students) ? raw.students : [];
        }
      } catch (e) { console.error('participants normalization error', e); }

      // Compute the students to display: either ALL, or students whose YR AND SEC is in sections OR whose STUDENT NO is in participants.students
      let displayStudents = [];
      const participantSections = new Set((participantsNorm.sections || []).map(x => String(x)));
      const participantStudentNos = new Set((participantsNorm.students || []).map(x => String(x).toLowerCase()));
      if (participantSections.has('ALL')) {
        displayStudents = allStudents.slice();
      } else {
        displayStudents = allStudents.filter(s => {
          const yrsec = s['YR AND SEC'] ? String(s['YR AND SEC']) : '';
          const studNo = s['STUDENT NO'] ? String(s['STUDENT NO']).toLowerCase() : '';
          return (yrsec && participantSections.has(yrsec)) || (studNo && participantStudentNos.has(studNo));
        });
      }

      // Get unique YR AND SEC values only from the displayStudents (so filter reflects participants)
      const yrSecSet = new Set();
      displayStudents.forEach(s => { if (s['YR AND SEC']) yrSecSet.add(s['YR AND SEC']); });
      // If participantSections is non-empty but no displayStudents have a YR AND SEC (e.g. only specific students), still expose participantSections
      (participantsNorm.sections || []).forEach(sec => { if (sec && sec !== 'ALL') yrSecSet.add(sec); });
      const options = ['ALL', ...Array.from(yrSecSet).sort()];
      const filterSelect = document.getElementById('attendanceYrSecFilter');
      filterSelect.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
      filterSelect.value = 'ALL';
      // Manual Logging UI: quick search + Log Time when device fails
      try {
        const manualWrap = document.getElementById('manualLoggingWrap');
        if (manualWrap) {
          // Search by Student Number (manual log when device fails)
          manualWrap.innerHTML = `
            <div style='display:flex;gap:8px;align-items:center;flex-wrap:nowrap;'>
            <input id='manualSearchStudentNo' placeholder='Search student number' style='flex:1;min-width:260px;height:38px;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:Arial, Helvetica, sans-serif;box-sizing:border-box;' />
            <button id='manualLogBtn' style='background:#1abc9c;color:#fff;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:600;height:38px;display:inline-flex;align-items:center;'>Log Time</button>
              <span id='manualLogMsg' style='margin-left:8px;color:green;white-space:nowrap;'></span>
            </div>`;

          const searchInput = document.getElementById('manualSearchStudentNo');
          const manualLogBtn = document.getElementById('manualLogBtn');
          const manualLogMsg = document.getElementById('manualLogMsg');

          // Click handler: search participants by STUDENT NO and log the first match
          manualLogBtn.addEventListener('click', async function() {
            manualLogMsg.textContent = '';
            const q = (searchInput.value || '').toString().trim().toLowerCase();
            if (!q) { manualLogMsg.style.color = 'red'; manualLogMsg.textContent = 'Type a student number to search'; return; }
            const matches = (displayStudents || []).filter(s => (s['STUDENT NO'] || '').toString().toLowerCase().includes(q));
            if (!matches || matches.length === 0) { manualLogMsg.style.color = 'red'; manualLogMsg.textContent = 'No matching participant found'; return; }
            const chosen = matches[0];
            const fid = Number(chosen.FID);
            if (isNaN(fid)) { manualLogMsg.style.color = 'red'; manualLogMsg.textContent = 'Selected student has invalid FID'; return; }
            manualLogBtn.disabled = true;
            manualLogBtn.textContent = 'Logging...';
            try {
              const resp = await fetch('/esp-log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fingerprintID: fid, eventId: eventId })
              });
              const data = await resp.json();
              if (resp.ok) {
                manualLogMsg.style.color = 'green';
                manualLogMsg.textContent = (data.message ? data.message + ' â€” ' : '') + (chosen.NAME || ('FID:' + fid));
                // refresh logs and re-render table
                try {
                  const refreshed = await fetch(`/logs?eventId=${eventId}`);
                  if (refreshed.ok) {
                    logs = await refreshed.json();
                    // re-render table with updated logs
                    renderFilteredAttendanceTable();
                  }
                } catch (e) { /* ignore refresh errors */ }
              } else {
                manualLogMsg.style.color = 'red';
                manualLogMsg.textContent = data.error || (data.message ? data.message : 'Failed to log');
              }
            } catch (err) {
              manualLogMsg.style.color = 'red';
              manualLogMsg.textContent = 'Error: ' + err.message;
            } finally {
              manualLogBtn.disabled = false;
              manualLogBtn.textContent = 'Log Time';
            }
          });
        }
      } catch (e) { console.error('manual logging init error', e); }
      // Pagination state
      let currentPage = 1;
      const rowsPerPage = 10;
      function renderFilteredAttendanceTable() {
        // Start from displayStudents (already filtered to participants)
        let filteredStudents = displayStudents;
        const yrSecVal = filterSelect.value;
        if (yrSecVal && yrSecVal !== 'ALL') {
          filteredStudents = displayStudents.filter(s => s['YR AND SEC'] === yrSecVal);
        }
        const totalRows = filteredStudents.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;
        const startIdx = (currentPage - 1) * rowsPerPage;
        const endIdx = Math.min(startIdx + rowsPerPage, totalRows);
        let html = `<table style='width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px rgba(44,62,80,0.04); font-size:0.82em;'>
          <thead>
              <tr style='background:#eef2f6;'>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>FID</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>STUDENT NO</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>NAME</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>YR AND SEC</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>TIME-IN</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:left;'>TIME-OUT</th>
                <th style='font-weight:700; color:#2c3e50; font-size:0.82em; letter-spacing:0.5px; text-align:center; width:48px;'> </th>
              </tr>
            </thead>
          <tbody>`;
          if (totalRows === 0) {
          html += "<tr><td colspan='7'>No students found for this Year & Section.</td></tr>";
        } else {
          const logsByFID = {};
          logs.forEach(log => { logsByFID[log.fingerprintID] = log; });
          for (let i = startIdx; i < endIdx; i++) {
            const s = filteredStudents[i];
            const log = logsByFID[s.FID] || null;
            const timeIn = log && log.timeIn ? new Date(log.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "";
            const timeOut = log && log.timeOut ? new Date(log.timeOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "";
              html += `<tr>
                <td style='text-align:left; font-size:0.82em;'>${s.FID ?? ''}</td>
                <td style='text-align:left; font-size:0.82em;'>${s["STUDENT NO"] ?? ''}</td>
                <td style='text-align:left; font-size:0.82em;'>${s.NAME ?? ''}</td>
                <td style='text-align:left; font-size:0.82em;'>${s["YR AND SEC"] ?? ''}</td>
                <td style='text-align:left; font-size:0.82em;'>${timeIn}</td>
                <td style='text-align:left; font-size:0.82em;'>${timeOut}</td>
                <td style='text-align:center; font-size:0.82em; padding:2px 6px;'>` + (log && log._id ? `<button class='delLogBtn' data-id='${log._id}' style='background:none;border:none;cursor:pointer;padding:4px;'><img src='https://img.icons8.com/ios-glyphs/20/000000/delete-sign.png' alt='Delete' style='width:18px;height:18px;opacity:0.85;' /></button>` : ``) + `</td>
              </tr>`;
          }
        }
        html += '</tbody></table>';
        // Pagination controls
        if (totalPages > 1) {
          html += `<div style='margin-top:12px; text-align:center;'>
            <button id='attendancePrevPageBtn' ${currentPage === 1 ? 'disabled' : ''} style='margin-right:8px;'>Prev</button>
            Page ${currentPage} of ${totalPages}
            <button id='attendanceNextPageBtn' ${currentPage === totalPages ? 'disabled' : ''} style='margin-left:8px;'>Next</button>
          </div>`;
        }
  document.getElementById('attendanceSheetTableWrap').innerHTML = html;
        // Attach pagination listeners
        if (totalPages > 1) {
          document.getElementById('attendancePrevPageBtn').onclick = function() {
            if (currentPage > 1) { currentPage--; renderFilteredAttendanceTable(); }
          };
          document.getElementById('attendanceNextPageBtn').onclick = function() {
            if (currentPage < totalPages) { currentPage++; renderFilteredAttendanceTable(); }
          };
        }
      }
      // Wire print button to use the same displayStudents and logs
      document.getElementById('printAttendanceBtn').onclick = function() {
        const yrSec = document.getElementById('attendanceYrSecFilter').value;
        let filteredStudentsForPrint = displayStudents;
        if (yrSec && yrSec !== 'ALL') filteredStudentsForPrint = displayStudents.filter(s => s['YR AND SEC'] === yrSec);
        const logsByFID = {};
        logs.forEach(log => { logsByFID[log.fingerprintID] = log; });
        let tableHtml = `<table style='width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(44,62,80,0.04);'>`;
        tableHtml += `<thead><tr style='background:#eef2f6;'>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>FID</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>STUDENT NO</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>NAME</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>YR AND SEC</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>TIME-IN</th>
          <th style='font-weight:700; color:#2c3e50; font-size:0.92em; letter-spacing:0.5px; text-align:left;'>TIME-OUT</th>
        </tr></thead><tbody>`;
        if (filteredStudentsForPrint.length === 0) {
          tableHtml += "<tr><td colspan='6'>No students found for this Year & Section.</td></tr>";
        } else {
          filteredStudentsForPrint.forEach(s => {
            const log = logsByFID[s.FID] || {};
            const timeIn = log.timeIn ? new Date(log.timeIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "";
            const timeOut = log.timeOut ? new Date(log.timeOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : "";
            tableHtml += `<tr>
              <td style='text-align:left; font-size:0.92em;'>${s.FID ?? ''}</td>
              <td style='text-align:left; font-size:0.92em;'>${s["STUDENT NO"] ?? ''}</td>
              <td style='text-align:left; font-size:0.92em;'>${s.NAME ?? ''}</td>
              <td style='text-align:left; font-size:0.92em;'>${s["YR AND SEC"] ?? ''}</td>
              <td style='text-align:left; font-size:0.92em;'>${timeIn}</td>
              <td style='text-align:left; font-size:0.92em;'>${timeOut}</td>
            </tr>`;
          });
        }
        tableHtml += '</tbody></table>';
        const win = window.open('', '', 'width=900,height=700');
        win.document.write(`
          <html><head><title>Print Attendance Sheet</title>
          <style>
            body { font-family: 'Segoe UI', Arial, sans-serif; margin: 32px; }
            h2 { color: #1abc9c; }
            .event-header { color: #2563eb; font-size: 1.15em; font-weight: 600; margin-bottom: 8px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(44,62,80,0.04); }
            th, td { padding: 12px 10px; border-bottom: 1px solid #e1e4e8; text-align: left; }
            th { background: #eef2f6; font-weight: 700; color: #2c3e50; font-size: 1em; letter-spacing: 0.5px; }
            tr:last-child td { border-bottom: none; }
          </style>
          </head><body>
            <h2>Attendance Sheet${yrSec && yrSec !== 'ALL' ? ' - ' + yrSec : ''}</h2>
            <div class="event-header">${eventName ? 'Event: ' + eventName : ''}</div>
            ${tableHtml}
          </body></html>
        `);
        win.document.close();
        win.focus();
        win.print();
      };

      filterSelect.onchange = function() { currentPage = 1; renderFilteredAttendanceTable(); };
      renderFilteredAttendanceTable();

      // Delegate clicks for delete buttons inside the attendance table
      try {
        const tableWrap = document.getElementById('attendanceSheetTableWrap');
        if (tableWrap) {
          tableWrap.addEventListener('click', function(e) {
            const btn = e.target.closest('.delLogBtn');
            if (!btn) return;
            e.stopPropagation();
            // remove any existing menu
            const existing = document.getElementById('attendanceDeleteMenu');
            if (existing) existing.remove();

            const rect = btn.getBoundingClientRect();
            const menu = document.createElement('div');
            menu.id = 'attendanceDeleteMenu';
            menu.style.position = 'absolute';
            menu.style.left = (rect.right + window.scrollX - 6) + 'px';
            menu.style.top = (rect.top + window.scrollY + rect.height + 4) + 'px';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #e1e4e8';
            menu.style.padding = '6px';
            menu.style.borderRadius = '8px';
            menu.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
            menu.style.zIndex = '10000';
            menu.innerHTML = `
              <div style='display:flex;flex-direction:column;gap:6px;min-width:160px;'>
                <button class='attDelOpt' data-action='delete-time-in' style='padding:8px;border-radius:6px;border:none;background:#f5f5f5;cursor:pointer;text-align:left;'>Delete Time-In</button>
                <button class='attDelOpt' data-action='delete-time-out' style='padding:8px;border-radius:6px;border:none;background:#f5f5f5;cursor:pointer;text-align:left;'>Delete Time-Out</button>
                <button class='attDelOpt' data-action='delete-both' style='padding:8px;border-radius:6px;border:none;background:#ff6b6b;color:#fff;cursor:pointer;text-align:left;'>Delete Both</button>
              </div>`;
            document.body.appendChild(menu);

            // Handle menu option click once
            menu.addEventListener('click', async function(ev) {
              const opt = ev.target.closest('.attDelOpt');
              if (!opt) return;
              const action = opt.getAttribute('data-action');
              const attId = btn.getAttribute('data-id');
              try {
                opt.disabled = true;
                const res = await fetch(`/attendance/${attId}/modify`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ action })
                });
                const json = await res.json();
                if (res.ok) {
                  // refresh logs and re-render
                  try {
                    const refreshed = await fetch(`/logs?eventId=${selectedEventId || eventId}`);
                    if (refreshed.ok) {
                      logs = await refreshed.json();
                      renderFilteredAttendanceTable();
                    }
                  } catch (e) { /* ignore refresh errors */ }
                  // small ephemeral message
                  const msg = document.createElement('div');
                  msg.style.position = 'fixed'; msg.style.left = (rect.left + window.scrollX) + 'px'; msg.style.top = (rect.top + window.scrollY - 28) + 'px';
                  msg.style.background = '#1abc9c'; msg.style.color = '#fff'; msg.style.padding = '6px 10px'; msg.style.borderRadius = '6px'; msg.style.zIndex = '11000';
                  msg.textContent = json.message || 'Deleted';
                  document.body.appendChild(msg);
                  setTimeout(() => msg.remove(), 1800);
                } else {
                  alert(json.error || json.message || 'Failed to update attendance');
                }
              } catch (err) {
                alert('Error: ' + err.message);
              } finally {
                menu.remove();
              }
            }, { once: true });

            // close menu on outside click
            const closeFn = function(ev) { if (!menu.contains(ev.target) && ev.target !== btn) { menu.remove(); document.removeEventListener('click', closeFn); } };
            setTimeout(() => document.addEventListener('click', closeFn), 10);
          });
        }
      } catch (e) { console.error('delete menu error', e); }
    }

    // Students list
    async function fetchStudents() {
      try {
  const res = await fetch('/students');
        const students = await res.json();
  window.studentsCache = students;
  updateYrSecFilterOptions();
  filterAndRenderStudents();
      } catch (err) {
        window.studentsCache = [];
        filterAndRenderStudents();
      }
    }

    // Search/filter logic
    document.addEventListener("DOMContentLoaded", function() {
      const searchInput = document.getElementById("searchStudentNo");
      if (searchInput) {
        searchInput.addEventListener("input", function() {
          filterAndRenderStudents();
        });
      }
      const filterYrSec = document.getElementById("filterYrSec");
      if (filterYrSec) {
        filterYrSec.addEventListener("change", function() {
          filterAndRenderStudents();
        });
      }
    });

    function updateYrSecFilterOptions() {
      const filterYrSec = document.getElementById("filterYrSec");
      if (!filterYrSec) return;
      const students = window.studentsCache || [];
      const yrSecSet = new Set();
      students.forEach(s => {
        if (s["YR AND SEC"]) yrSecSet.add(s["YR AND SEC"]);
      });
      const options = ["ALL", ...Array.from(yrSecSet).sort()];
      const prev = filterYrSec.value;
      filterYrSec.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join("");
      // Preserve previous selection if it still exists, otherwise default to ALL
      if (prev && options.indexOf(prev) !== -1) {
        filterYrSec.value = prev;
      } else {
        filterYrSec.value = "ALL";
      }
    }

    function filterAndRenderStudents() {
      const students = window.studentsCache || [];
      const searchVal = (document.getElementById("searchStudentNo")?.value || "").trim().toLowerCase();
      const yrSecVal = (document.getElementById("filterYrSec")?.value || "ALL");
      let filtered = students;
      if (searchVal) {
        filtered = filtered.filter(s => String(s["STUDENT NO"]).toLowerCase().includes(searchVal));
      }
      if (yrSecVal && yrSecVal !== "ALL") {
        filtered = filtered.filter(s => s["YR AND SEC"] === yrSecVal);
      }
        // Sort by Year & Section (year number then section) then by NAME (alphabetical)
        function parseYrSec(v) {
          const raw = (v || '').toString().trim();
          if (!raw) return { year: 9999, section: '' };
          const yearMatch = raw.match(/(\d+)/);
          const year = yearMatch ? parseInt(yearMatch[1], 10) : 9999;
          // Try to capture section: look for text after '-' or trailing letters
          let section = '';
          const dashMatch = raw.match(/-([A-Za-z0-9]+)$/);
          if (dashMatch) section = dashMatch[1];
          else {
            const trailingMatch = raw.match(/([A-Za-z]+)$/);
            if (trailingMatch) section = trailingMatch[1];
          }
          return { year: year, section: (section || '').toUpperCase() };
        }
        filtered.sort((a, b) => {
          const aKey = parseYrSec(a['YR AND SEC']);
          const bKey = parseYrSec(b['YR AND SEC']);
          if (aKey.year !== bKey.year) return aKey.year - bKey.year;
          if (aKey.section !== bKey.section) return aKey.section.localeCompare(bKey.section);
          const aName = (a.NAME || '').toString().toLowerCase();
          const bName = (b.NAME || '').toString().toLowerCase();
          if (aName < bName) return -1;
          if (aName > bName) return 1;
          return 0;
        });
        renderStudentsTable(filtered);
    }

    function renderStudentsTable(students) {
      const table = document.getElementById("studentTable");
      table.innerHTML = "";
      if (students.length === 0) {
        table.innerHTML = "<tr><td colspan='7' style='font-size:0.92em; padding:8px 6px;'>No students found.</td></tr>";
      } else {
        students.forEach((s, idx) => {
          const row = `<tr style='line-height:0.7;'>
            <td style='text-align:left; font-size:0.78em; padding:2px 8px;'>${s.FID ?? ''}</td>
            <td style='text-align:left; font-size:0.78em; padding:2px 8px;'>${s["STUDENT NO"] ?? ''}</td>
            <td style='text-align:left; font-size:0.78em; padding:2px 8px;'>${s.NAME ?? ''}</td>
            <td style='text-align:left; font-size:0.78em; padding:2px 8px;'>${s.SEX ?? ''}</td>
            <td style='text-align:left; font-size:0.78em; padding:2px 16px 2px 8px;'>${s["YR AND SEC"] ?? ''}</td>
            <td style='text-align:left; font-size:0.78em; padding:2px 8px;'>${s.EMAIL ?? ''}</td>
            <td style="text-align:center; font-size:0.78em; padding:2px 8px;">
              <button class="editBtn" data-idx="${idx}" title="Edit Student" style="background:none;border:none;cursor:pointer;padding:2px 4px;">
                  <img src="https://img.icons8.com/office/40/edit.png" alt="Edit" style="width:26px;height:26px;vertical-align:middle;" />
              </button>
            </td>
          </tr>`;
          table.innerHTML += row;
        });
        // Attach edit event listeners
        Array.from(document.getElementsByClassName('editBtn')).forEach(btn => {
          btn.onclick = function() {
            const idx = btn.getAttribute('data-idx');
            const student = students[idx];
            showEditStudentPopup(student);
          };
        });
      }
    }

    function showEditStudentPopup(student) {
      // Remove any existing popup
      const old = document.getElementById('editStudentPopup');
      if (old) old.remove();
      // Create popup
      const popup = document.createElement('div');
      popup.id = 'editStudentPopup';
      popup.style.position = 'fixed';
      popup.style.top = '0';
      popup.style.left = '0';
      popup.style.width = '100vw';
      popup.style.height = '100vh';
      popup.style.background = 'rgba(0,0,0,0.15)';
      popup.style.display = 'flex';
      popup.style.alignItems = 'center';
      popup.style.justifyContent = 'center';
      popup.style.zIndex = '9999';
      popup.innerHTML = `
        <div style="background:#fff;padding:28px 20px;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.12);min-width:380px;max-width:86vw;display:flex;flex-direction:column;align-items:center;">
          <h3 style='margin-top:0;margin-bottom:14px;'>Edit Student Details</h3>
          <form id='editStudentForm' style='display:flex;flex-wrap:wrap;gap:14px 20px;justify-content:center;'>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Fingerprint ID</label>
              <input type='number' id='editFID' value='${student.FID}' required min='1' style='width:100%;padding:8px;'>
            </div>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Student Number</label>
              <input type='text' id='editStudentNo' value='${student["STUDENT NO"]}' required style='width:100%;padding:8px;'>
            </div>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Year & Section</label>
              <input type='text' id='editYrSec' value='${student["YR AND SEC"]}' required style='width:100%;padding:8px;'>
            </div>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Sex</label>
              <select id='editSex' required style='width:100%;padding:8px;'>
                <option value=''>Select</option>
                <option value='Male' ${student.SEX==='Male'?'selected':''}>Male</option>
                <option value='Female' ${student.SEX==='Female'?'selected':''}>Female</option>
              </select>
            </div>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Name</label>
              <input type='text' id='editName' value='${student.NAME}' required style='width:100%;padding:8px;'>
            </div>
            <div class='form-group' style='flex:1 1 220px;min-width:160px;'>
              <label>Email</label>
              <input type='email' id='editEmail' value='${student.EMAIL}' required style='width:100%;padding:8px;'>
            </div>
          </form>
          <div style='display:flex;gap:10px;margin-top:18px;justify-content:flex-end;align-items:center;flex-wrap:nowrap;'>
            <button type='button' id='cancelEditBtn' style='display:flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:40px;cursor:pointer;min-width:110px;height:40px;background:#f5f5f5;color:#333;padding:0 12px;border:none;border-radius:8px;font-weight:600;font-size:0.95em;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.18s;'>Cancel</button>
            <button type='button' id='deleteStudentBtn' style='display:flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:40px;cursor:pointer;min-width:110px;height:40px;background:#e74c3c;color:#fff;padding:0 12px;border:none;border-radius:8px;font-weight:600;font-size:0.95em;box-shadow:0 1px 4px rgba(231,76,60,0.18);transition:background 0.18s;'>Delete</button>
            <button type='submit' form='editStudentForm' style='display:flex;align-items:center;justify-content:center;box-sizing:border-box;line-height:40px;cursor:pointer;min-width:110px;height:40px;background:#1abc9c;color:#fff;padding:0 12px;border:none;border-radius:8px;font-weight:600;font-size:0.95em;box-shadow:0 1px 4px rgba(26,188,156,0.18);transition:background 0.18s;'>Save Changes</button>
          </div>
          <div id='editStudentMsg' style='margin-top:12px;color:green;'></div>
        </div>
      `;
      document.body.appendChild(popup);
      document.getElementById('cancelEditBtn').onclick = () => popup.remove();
      document.getElementById('editStudentForm').onsubmit = async function(e) {
        e.preventDefault();
        // Collect updated data
        const FID = parseInt(document.getElementById('editFID').value, 10);
        const STUDENT_NO = document.getElementById('editStudentNo').value.trim();
        const NAME = document.getElementById('editName').value.trim();
        const SEX = document.getElementById('editSex').value;
        const YR_AND_SEC = document.getElementById('editYrSec').value.trim();
        const EMAIL = document.getElementById('editEmail').value.trim();
        const msg = document.getElementById('editStudentMsg');
        msg.textContent = '';
        // Send update to backend
        try {
          const res = await fetch(`/students/${student.FID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ FID, "STUDENT NO": STUDENT_NO, NAME, SEX, "YR AND SEC": YR_AND_SEC, EMAIL })
          });
          const result = await res.json();
          if (res.ok) {
            msg.textContent = 'Student updated successfully!';
            msg.style.color = 'green';
            setTimeout(() => { popup.remove(); if (typeof fetchStudents === 'function') fetchStudents(); }, 1200);
          } else {
            msg.textContent = result.error || 'Failed to update student.';
            msg.style.color = 'red';
          }
        } catch (error) {
          msg.textContent = 'Error: ' + error.message;
          msg.style.color = 'red';
        }
      };
      document.getElementById('deleteStudentBtn').onclick = async function() {
        if (confirm('Are you sure you want to delete this student?')) {
          try {
            const res = await fetch(`/students/${student.FID}`, { method: 'DELETE' });
            const result = await res.json();
            if (res.ok) {
              popup.remove();
              if (typeof fetchStudents === 'function') fetchStudents();
            } else {
              alert(result.error || 'Failed to delete student.');
            }
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      };
    }

    // Initial load
    fetchStudents();

    // Sidebar navigation
  const studentsBtn = document.getElementById("studentsBtn");
  const eventsBtn = document.getElementById("eventsBtn");
  const enrollBtn = document.getElementById("enrollBtn");
  const analyticsBtn = document.getElementById("analyticsBtn");
  const studentAnalyticsBtn = document.getElementById("studentAnalyticsBtn");
  const studentsSection = document.getElementById("studentsSection");
  const eventsSection = document.getElementById("eventsSection");
  const enrollSection = document.getElementById("enrollSection");
  const analyticsSection = document.getElementById("analyticsSection");
  const studentAnalyticsSection = document.getElementById("studentAnalyticsSection");
  // studentsAddBtn (sidebar) removed; keep studentsCardAddBtn inside Students card for enroll modal

    function hideAllSections() {
      if (studentsSection) studentsSection.style.display = "none";
      if (eventsSection) eventsSection.style.display = "none";
      if (enrollSection) enrollSection.style.display = "none";
      if (analyticsSection) analyticsSection.style.display = "none";
      if (studentAnalyticsSection) studentAnalyticsSection.style.display = "none";
      if (studentsBtn) studentsBtn.classList.remove("active");
      if (eventsBtn) eventsBtn.classList.remove("active");
  // enrollBtn removed from sidebar; enrollment is handled via modal opened from Students card
      if (analyticsBtn) analyticsBtn.classList.remove("active");
      if (studentAnalyticsBtn) studentAnalyticsBtn.classList.remove("active");
    }

    if (studentsBtn) studentsBtn.addEventListener("click", () => {
      hideAllSections();
      if (studentsSection) studentsSection.style.display = "block";
      if (studentsBtn) studentsBtn.classList.add("active");
    });

    if (eventsBtn) eventsBtn.addEventListener("click", () => {
      hideAllSections();
      if (eventsSection) eventsSection.style.display = "block";
      if (eventsBtn) eventsBtn.classList.add("active");
      updateStudentsCache(); // Always refresh students before showing event management
    });

    // sidebar enrollBtn removed - enrollment opens via Students card + button/modal

    // Wire the floating + icon to open the enroll section (same behavior as enrollBtn)
    // legacy studentsAddBtn behavior removed; Students-card + opens the modal instead

    if (analyticsBtn) analyticsBtn.addEventListener("click", () => {
      hideAllSections();
      if (analyticsSection) analyticsSection.style.display = "block";
      if (analyticsBtn) analyticsBtn.classList.add("active");
        // Fetch events and update total events card
  fetch('/events')
          .then(res => res.json())
          .then(events => {
            const totalEvents = Array.isArray(events) ? events.length : 0;
              const totalEventsCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[0] : null;
              if (totalEventsCard) totalEventsCard.textContent = totalEvents;
          })
          .catch(() => {
              const totalEventsCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[0] : null;
              if (totalEventsCard) totalEventsCard.textContent = "0";
          });

          // Fetch students and update total students card
          fetch('/students')
            .then(res => res.json())
            .then(students => {
              const totalStudents = Array.isArray(students) ? students.length : 0;
                const totalStudentsCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[1] : null;
                if (totalStudentsCard) totalStudentsCard.textContent = totalStudents;

                // Fetch events and attendance to compute average attendance
                fetch('/events')
                  .then(res => res.json())
                  .then(events => {
                    if (!Array.isArray(events) || events.length === 0 || totalStudents === 0) {
                      const avgAttendanceCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[2] : null;
                      if (avgAttendanceCard) avgAttendanceCard.textContent = "0%";
                      return;
                    }
                    // For each event, fetch attendance logs and compute rate
                    Promise.all(events.map(ev =>
                      fetch(`/logs?eventId=${ev._id}`)
                        .then(res => res.json())
                        .then(logs => {
                          // Count unique fingerprintIDs with both timeIn and timeOut
                          const attended = Array.isArray(logs) ? logs.filter(l => l.timeIn && l.timeOut).map(l => l.fingerprintID) : [];
                          const uniqueAttended = new Set(attended);
                          return uniqueAttended.size;
                        })
                        .catch(() => 0)
                    )).then(attendanceCounts => {
                      // Compute attendance rate per event
                      const rates = attendanceCounts.map(count => (count / totalStudents) * 100);
                      const avgRate = rates.length > 0 ? (rates.reduce((a, b) => a + b, 0) / rates.length) : 0;
                     
                      const avgAttendanceCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[2] : null;
                      if (avgAttendanceCard) avgAttendanceCard.textContent = `${avgRate.toFixed(1)}%`;
                    });
                  });
            })
            .catch(() => {
              const totalStudentsCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[1] : null;
              if (totalStudentsCard) totalStudentsCard.textContent = "0";
                const avgAttendanceCard = analyticsSection ? analyticsSection.querySelectorAll(".card-value")[2] : null;
                if (avgAttendanceCard) avgAttendanceCard.textContent = "0%";
            });
    });

    if (studentAnalyticsBtn) studentAnalyticsBtn.addEventListener("click", () => {
      hideAllSections();
      if (studentAnalyticsSection) studentAnalyticsSection.style.display = "block";
      if (studentAnalyticsBtn) studentAnalyticsBtn.classList.add("active");
    });

    // Default view
    hideAllSections();
    studentsSection.style.display = "block";
    studentsBtn.classList.add("active");

    // Refresh periodically
    setInterval(fetchStudents, 10000);

    document.addEventListener("DOMContentLoaded", function() {
  const enrollForm = document.getElementById("enrollForm");
  const enrollMsg = document.getElementById("enrollMsg");
  const loginContainer = document.getElementById("loginContainer");
  const dashboardContainer = document.getElementById("dashboardContainer");
  if (enrollForm && enrollMsg) {
    enrollForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      // Only show login if not authenticated
      if (!localStorage.getItem("authToken")) {
        loginContainer.style.display = "flex";
        dashboardContainer.style.display = "none";
        return;
      }
      const FID = document.getElementById("enrollFID").value;
      const STUDENT_NO = document.getElementById("enrollStudentNo").value;
      const NAME = document.getElementById("enrollName").value;
      const SEX = document.getElementById("enrollSex").value;
      const YR_AND_SEC = document.getElementById("enrollYrSec").value;
      const EMAIL = document.getElementById("enrollEmail").value;
      enrollMsg.textContent = "";
      try {
        const res = await fetch('/students', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ FID, "STUDENT NO": STUDENT_NO, NAME, SEX, "YR AND SEC": YR_AND_SEC, EMAIL })
        });
        if (res.ok) {
          enrollMsg.textContent = "Student Enrolled!";
          enrollMsg.style.color = "green";
          enrollForm.reset();
          if (typeof fetchStudents === 'function') fetchStudents();
        } else {
          const err = await res.json();
          enrollMsg.textContent = err.error || "Failed to enroll student.";
          enrollMsg.style.color = "red";
        }
      } catch (error) {
        enrollMsg.textContent = "Error: " + error.message;
        enrollMsg.style.color = "red";
      }
      setTimeout(() => {
        enrollMsg.textContent = "";
        enrollMsg.style.color = "green";
      }, 3000);
    });
  }
});
  </script>
</body>
<script>
// Show only the relevant section when a sidebar button is clicked
document.addEventListener('DOMContentLoaded', function() {
  const sectionIds = [
    'studentsSection',
    'enrollSection',
    'eventsSection',
    'analyticsSection',
    'ecertificateSection',
    'studentAnalyticsSection' // in case you have this section
  ];
  const buttonSectionMap = {
    studentsBtn: 'studentsSection',
    enrollBtn: 'enrollSection',
    eventsBtn: 'eventsSection',
    analyticsBtn: 'analyticsSection',
    ecertificateBtn: 'ecertificateSection',
    studentAnalyticsBtn: 'studentAnalyticsSection'
  };
  Object.keys(buttonSectionMap).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.addEventListener('click', function() {
        sectionIds.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = (id === buttonSectionMap[btnId]) ? '' : 'none';
        });
        document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    }
  });
});
</script>
</html>
